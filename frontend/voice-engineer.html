<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>è¯­è¨€æ¨¡å‹å·¥ç¨‹å¸ˆå·¥ä½œå° - å£°éŸ³æ¨¡å‹ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./style.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top left, #0b1120 0, #020617 45%, #000 100%);
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-primary);
    }
    .ve-container {
      max-width: 1120px;
      margin: 0 auto;
      padding: 28px 18px 40px;
      box-sizing: border-box;
    }
    .ve-header {
      margin-bottom: 20px;
      padding: 16px 20px;
      border-radius: 16px;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.18), transparent 55%),
                  radial-gradient(circle at top right, rgba(94, 234, 212, 0.16), transparent 55%),
                  rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.8);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .ve-header-title h1 {
      margin: 0;
      font-size: 22px;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .ve-header-title p {
      margin: 4px 0 0;
      font-size: 13px;
      color: #9ca3af;
    }
    .ve-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 11px;
    }
    .ve-main-grid {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.4fr);
      gap: 18px;
      align-items: flex-start;
    }
    .ve-card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.75);
      padding: 14px 16px 16px;
    }
    .ve-card h2 {
      margin: 0 0 8px;
      font-size: 16px;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .ve-card p {
      margin: 0 0 8px;
      font-size: 13px;
      color: #9ca3af;
    }
    .ve-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      border-radius: 10px;
      overflow: hidden;
    }
    .ve-table th,
    .ve-table td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      text-align: left;
    }
    .ve-table th {
      background: rgba(15, 23, 42, 0.98);
      color: #e5e7eb;
      font-weight: 600;
    }
    .ve-table td {
      color: #f3f4f6;
    }
    .ve-table tr:hover td {
      background: rgba(31, 41, 55, 0.9);
    }
    .ve-status-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .ve-status-pill.ready {
      background: rgba(22, 163, 74, 0.15);
      border: 1px solid rgba(22, 163, 74, 0.8);
      color: #bbf7d0;
    }
    .ve-status-pill.pending {
      background: rgba(245, 158, 11, 0.15);
      border: 1px solid rgba(245, 158, 11, 0.8);
      color: #fed7aa;
    }
    .ve-status-pill.error {
      background: rgba(248, 113, 113, 0.15);
      border: 1px solid rgba(248, 113, 113, 0.8);
      color: #fecaca;
    }
    .ve-small-label {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .ve-select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.98);
      color: #e5e7eb;
      font-size: 13px;
    }
    .ve-row {
      margin-bottom: 10px;
    }
    .ve-helper {
      font-size: 12px;
      color: #6b7280;
      margin-top: 3px;
    }
    .ve-pill-assistant {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.6);
      font-size: 11px;
      color: #e5e7eb;
    }
    .ve-link-back {
      font-size: 12px;
      color: #93c5fd;
      text-decoration: none;
    }
    .ve-link-back:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="ve-container">
    <header class="ve-header">
      <div class="ve-header-title">
        <h1>ğŸ§  è¯­è¨€æ¨¡å‹å·¥ç¨‹å¸ˆå·¥ä½œå°</h1>
        <p>é›†ä¸­ç®¡ç†å…¬å¸å†…éƒ¨çš„å£°éŸ³æ¨¡å‹ï¼Œå¹¶ä¸ºå°ç¢Ÿ / å°åˆ˜ç­‰åŠ©æ‰‹ç»‘å®šåˆé€‚çš„å£°çº¿ã€‚</p>
      </div>
      <div>
        <span class="ve-tag">ğŸ™ å£°éŸ³æ¨¡å‹ä¸­å¿ƒ</span>
        <a href="./index.html" class="ve-link-back">â† è¿”å›ç»„ç»‡æ¶æ„è§†å›¾</a>
      </div>
    </header>

    <main class="ve-main-grid">
      <section class="ve-card">
        <h2>ğŸ§ å£°éŸ³æ¨¡å‹åˆ—è¡¨</h2>
        <p>ä¸‹è¡¨å±•ç¤ºäº†å½“å‰å·²é€šè¿‡ã€Œä¸€é”®å…‹éš†ã€ä¸Šä¼ å¹¶ç™»è®°çš„è¯´è¯äººï¼Œå¯ç”¨äº TTS / åŠ©æ‰‹æ’­æŠ¥ã€‚</p>
        <div id="ve-voices-empty" class="ve-helper" style="display:none;">æš‚æ—¶è¿˜æ²¡æœ‰å£°éŸ³æ¨¡å‹ï¼Œè¯·åœ¨å‘˜å·¥ AI èœå•ä¸­ä¸Šä¼ è¯­éŸ³è¿›è¡Œå…‹éš†ã€‚</div>
        <table class="ve-table" id="ve-voices-table" style="display:none;">
          <thead>
            <tr>
              <th>è¯´è¯äºº</th>
              <th>è¯­è¨€</th>
              <th>çŠ¶æ€</th>
              <th>æ¨¡å¼</th>
              <th>å¤‡æ³¨</th>
            </tr>
          </thead>
          <tbody id="ve-voices-tbody"></tbody>
        </table>
      </section>

      <section class="ve-card">
        <h2>ğŸ¤– åŠ©æ‰‹å£°éŸ³ç»‘å®š</h2>
        <p>ä¸ºå…³é”®åŠ©æ‰‹ç»‘å®šå…·ä½“å£°çº¿ï¼Œåç»­åŠ©æ‰‹åœ¨è¯´è¯ / æ’­æŠ¥æ—¶å³å¯ä½¿ç”¨å¯¹åº”çš„äººå£°æ¨¡å‹ã€‚</p>

        <div class="ve-row">
          <div class="ve-small-label">
            <span class="ve-pill-assistant">ğŸ¦‹ å°ç¢ŸåŠ©æ‰‹</span>
            <span>â€” ä¾§è¾¹æ çŸ¥è¯† / ç»„ç»‡æ¶æ„çš„å°åŠ©æ‰‹</span>
          </div>
          <select id="ve-assistant-xiaodie" class="ve-select">
            <option value="">ï¼ˆä½¿ç”¨é»˜è®¤å£°çº¿ï¼‰</option>
          </select>
          <div class="ve-helper">å»ºè®®ä¸ºå°ç¢Ÿé€‰æ‹©ä¸€ä½è¯­é€Ÿé€‚ä¸­ã€è¯­æ°”äº²å’Œçš„å¥³å£°æˆ–ä¸­æ€§éŸ³ã€‚</div>
        </div>

        <div class="ve-row">
          <div class="ve-small-label">
            <span class="ve-pill-assistant">ğŸ‘” å°åˆ˜ï¼ˆè´¢åŠ¡ï¼‰</span>
            <span>â€” è´¢åŠ¡å·¥ä½œå° / æŠ¥è¡¨æ’­æŠ¥åŠ©æ‰‹</span>
          </div>
          <select id="ve-assistant-xiaoliu" class="ve-select">
            <option value="">ï¼ˆä½¿ç”¨é»˜è®¤å£°çº¿ï¼‰</option>
          </select>
          <div class="ve-helper">å»ºè®®ä¸ºå°åˆ˜é€‰æ‹©åä¸“ä¸šã€ç¨³é‡çš„å£°çº¿ï¼Œç”¨äºè¯»æŠ¥è¡¨ / è§£é‡Šæ•°å­—ã€‚</div>
        </div>

        <button id="ve-save-assistants" class="ai-menu-btn" style="margin-top:8px;">ğŸ’¾ ä¿å­˜åŠ©æ‰‹å£°éŸ³é…ç½®</button>
        <p class="ve-helper" id="ve-save-status" style="margin-top:6px;"></p>

        <hr style="border-color: rgba(31,41,55,0.9); margin:14px 0;" />

        <h2 style="font-size:15px; margin-bottom:6px;">âš¡ ä¸€é”®å…‹éš†æ–°å£°éŸ³</h2>
        <p class="ve-helper" style="margin-bottom:8px;">
          åœ¨è¿™é‡Œç›´æ¥ä¸Šä¼ å¹²å‡€äººå£°ï¼Œç³»ç»Ÿä¼šåœ¨åå°è‡ªåŠ¨æ‰§è¡Œåˆ‡åˆ† / ASR æ ‡æ³¨ï¼Œå¹¶ç™»è®°ä¸ºæ–°çš„å£°éŸ³æ¨¡å‹ã€‚
        </p>

        <div class="ve-row">
          <div class="ve-small-label">è¯´è¯äººåç§°</div>
          <input id="ve-clone-name" type="text" placeholder="ä¾‹å¦‚ï¼šæŠ–éŸ³è¿è¥è´Ÿè´£äººå¥³å£°" class="ve-select" style="background:#020617;" />
        </div>

        <div class="ve-row">
          <div class="ve-small-label">è¯­è¨€</div>
          <select id="ve-clone-lang" class="ve-select">
            <option value="zh">ä¸­æ–‡ï¼ˆzhï¼‰</option>
            <option value="en">è‹±æ–‡ï¼ˆenï¼‰</option>
            <option value="ja">æ—¥æ–‡ï¼ˆjaï¼‰</option>
            <option value="auto">è‡ªåŠ¨è¯†åˆ«ï¼ˆautoï¼‰</option>
          </select>
        </div>

        <div class="ve-row">
          <div class="ve-small-label">ä¸Šä¼ è¯­éŸ³æ–‡ä»¶ï¼ˆæ”¯æŒå¤šæ®µï¼Œå°½é‡ä¸ºå¹²å‡€äººå£°ï¼‰</div>
          <input id="ve-clone-files" type="file" accept="audio/*" multiple style="width:100%; font-size:12px;" />
          <div class="ve-helper">å¯ä¸€æ¬¡ä¸Šä¼ å¤šæ®µè¯­éŸ³ï¼Œæ€»æ—¶é•¿å»ºè®® 30 ç§’ ~ 2 åˆ†é’Ÿã€‚</div>
        </div>

        <button id="ve-clone-btn" class="ai-menu-btn" style="margin-top:6px;">âš¡ ä¸Šä¼ å¹¶ä¸€é”®å…‹éš†</button>
        <p class="ve-helper" id="ve-clone-status" style="margin-top:6px;"></p>
      </section>
    </main>
  </div>

  <script>
    const API_BASE = 'http://localhost:8080';

    async function loadVoices() {
      try {
        const resp = await fetch(API_BASE + '/api/voices');
        const result = await resp.json();
        if (!resp.ok || result.success === false) {
          const msg = result && result.error && result.error.message ? result.error.message : resp.status;
          throw new Error('è¯·æ±‚å¤±è´¥ ' + msg + 'ï¼ˆè¯·ç¡®è®¤åç«¯ Node æœåŠ¡å·²é‡å¯å¹¶åŒ…å« /api/voices æ¥å£ï¼‰');
        }
        const voices = Array.isArray(result.data) ? result.data : [];

        const tbody = document.getElementById('ve-voices-tbody');
        const table = document.getElementById('ve-voices-table');
        const empty = document.getElementById('ve-voices-empty');
        const selXiaodie = document.getElementById('ve-assistant-xiaodie');
        const selXiaoliu = document.getElementById('ve-assistant-xiaoliu');

        if (!Array.isArray(voices) || voices.length === 0) {
          empty.style.display = 'block';
          table.style.display = 'none';
          return;
        }

        empty.style.display = 'none';
        table.style.display = 'table';

        tbody.innerHTML = '';
        // ç¼“å­˜ä¸€ä»½å®Œæ•´çš„ voices åˆ—è¡¨ï¼Œæ–¹ä¾¿å…¶ä»–é¡µé¢/é€»è¾‘ä½¿ç”¨
        window.voicesCache = voices;

        voices.forEach((v) => {
          const tr = document.createElement('tr');
          const tdName = document.createElement('td');
          const tdLang = document.createElement('td');
          const tdStatus = document.createElement('td');
          const tdMode = document.createElement('td');
          const tdNote = document.createElement('td');

          tdName.textContent = v.displayName || v.speakerId;
          tdLang.textContent = (v.lang || '').toUpperCase() || '-';

          const statusSpan = document.createElement('span');
          const status = v.status || 'ready';
          statusSpan.className = 've-status-pill ' + (status === 'ready' ? 'ready' : status === 'pending' ? 'pending' : 'error');
          statusSpan.textContent = status === 'ready' ? 'å¯ç”¨' : status === 'pending' ? 'å¤„ç†ä¸­' : 'å¼‚å¸¸';
          tdStatus.appendChild(statusSpan);

          tdMode.textContent = v.mode || 'zero-shot';
          tdNote.textContent = v.listPath ? 'å·²ç”Ÿæˆæ ‡æ³¨ Â· ' + v.listPath : 'â€”';

          tr.appendChild(tdName);
          tr.appendChild(tdLang);
          tr.appendChild(tdStatus);
          tr.appendChild(tdMode);
          tr.appendChild(tdNote);
          tbody.appendChild(tr);

          // åŒæ­¥åˆ°åŠ©æ‰‹ä¸‹æ‹‰æ¡†
          const opt1 = document.createElement('option');
          opt1.value = v.speakerId;
          opt1.textContent = v.displayName || v.speakerId;
          selXiaodie.appendChild(opt1);

          const opt2 = document.createElement('option');
          opt2.value = v.speakerId;
          opt2.textContent = v.displayName || v.speakerId;
          selXiaoliu.appendChild(opt2);
        });

        // è¯»å–æœ¬åœ°å·²ä¿å­˜çš„åŠ©æ‰‹å£°éŸ³ç»‘å®š
        let assistantVoices = {};
        try {
          const raw = localStorage.getItem('assistantVoices');
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === 'object') assistantVoices = parsed;
          }
        } catch (e) {
          assistantVoices = {};
        }

        if (assistantVoices.xiaodie && [...selXiaodie.options].some(o => o.value === assistantVoices.xiaodie)) {
          selXiaodie.value = assistantVoices.xiaodie;
        }
        if (assistantVoices.xiaoliu && [...selXiaoliu.options].some(o => o.value === assistantVoices.xiaoliu)) {
          selXiaoliu.value = assistantVoices.xiaoliu;
        }

        // æš´éœ²åˆ°å…¨å±€ï¼Œæ–¹ä¾¿å…¶ä»–é¡µé¢è¯»å–
        window.assistantVoices = assistantVoices;
      } catch (e) {
        console.error('åŠ è½½å£°éŸ³æ¨¡å‹å¤±è´¥:', e);
        const empty = document.getElementById('ve-voices-empty');
        empty.style.display = 'block';
        empty.textContent = 'åŠ è½½å£°éŸ³æ¨¡å‹å¤±è´¥ï¼š' + e.message;
      }
    }

    function bindSaveAssistants() {
      const btn = document.getElementById('ve-save-assistants');
      const out = document.getElementById('ve-save-status');
      const selXiaodie = document.getElementById('ve-assistant-xiaodie');
      const selXiaoliu = document.getElementById('ve-assistant-xiaoliu');

      btn.addEventListener('click', () => {
        const voices = Array.isArray(window.voicesCache) ? window.voicesCache : [];
        const findVoiceLang = (speakerId) => {
          if (!speakerId) return '';
          const v = voices.find(vo => vo.speakerId === speakerId);
          return v && v.lang ? String(v.lang).toLowerCase() : '';
        };

        const xiaodieId = selXiaodie.value || '';
        const xiaoliuId = selXiaoliu.value || '';

        const config = {
          xiaodie: xiaodieId,
          xiaoliu: xiaoliuId,
          xiaodieLang: findVoiceLang(xiaodieId),
          xiaoliuLang: findVoiceLang(xiaoliuId)
        };
        localStorage.setItem('assistantVoices', JSON.stringify(config));
        window.assistantVoices = config;
        out.textContent = 'å·²ä¿å­˜åŠ©æ‰‹å£°éŸ³é…ç½®ã€‚å°ç¢Ÿ / å°åˆ˜ åç»­è¯´è¯æ—¶å¯è¯»å–å¯¹åº”å£°çº¿ã€‚';
        out.style.color = '#4ade80';
        setTimeout(() => {
          out.textContent = '';
        }, 3000);
      });
    }

    async function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = (err) => reject(err);
        reader.readAsDataURL(file);
      });
    }

    function bindCloneForm() {
      const btn = document.getElementById('ve-clone-btn');
      const out = document.getElementById('ve-clone-status');
      const nameInput = document.getElementById('ve-clone-name');
      const langSelect = document.getElementById('ve-clone-lang');
      const filesInput = document.getElementById('ve-clone-files');

      btn.addEventListener('click', async () => {
        const displayName = (nameInput.value || '').trim();
        const lang = (langSelect.value || 'zh').trim();
        const files = Array.from(filesInput.files || []);

        if (!displayName) {
          out.textContent = 'è¯·å…ˆå¡«å†™è¯´è¯äººåç§°ã€‚';
          out.style.color = '#f97373';
          return;
        }
        if (files.length === 0) {
          out.textContent = 'è¯·è‡³å°‘é€‰æ‹©ä¸€æ®µè¯­éŸ³æ–‡ä»¶ã€‚';
          out.style.color = '#f97373';
          return;
        }

        out.textContent = 'æ­£åœ¨ä¸Šä¼ å¹¶è§¦å‘åå°å¤„ç†ï¼Œè¯·ç¨å€™...';
        out.style.color = '#e5e7eb';

        try {
          const encodedFiles = [];
          for (const f of files) {
            const dataUrl = await toBase64(f);
            encodedFiles.push({
              filename: f.name,
              dataBase64: dataUrl
            });
          }

          // ç”Ÿæˆä¸€ä¸ªç›¸å¯¹ç¨³å®šçš„ speakerIdï¼šåŸºäºåç§° + æ—¶é—´æˆ³
          const baseId = displayName.replace(/[^a-zA-Z0-9_\-]/g, '_') || 'voice';
          const speakerId = baseId.toLowerCase() + '_' + Date.now();

          const resp = await fetch(API_BASE + '/api/voice-dataset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              speakerId,
              displayName,
              lang,
              ownerType: 'custom',
              ownerId: null,
              files: encodedFiles
            })
          });

          const result = await resp.json();
          if (!resp.ok || result.success === false) {
            const msg = result && result.error && result.error.message ? result.error.message : ('åç«¯è¿”å›é”™è¯¯ï¼š' + resp.status);
            throw new Error(msg);
          }

          const data = result.data || {};
          out.textContent = `å·²ä¸Šä¼ è¯­éŸ³å¹¶è§¦å‘åå°å¤„ç†ï¼š${data.displayName}ï¼ˆ${data.speakerId}ï¼‰ã€‚è¯·ç¨ååˆ·æ–°æŸ¥çœ‹åˆ—è¡¨çŠ¶æ€ã€‚`;
          out.style.color = '#4ade80';

          // ç®€å•åˆ·æ–°ä¸€æ¬¡å£°éŸ³åˆ—è¡¨ï¼ˆä¸ä¼šé˜»å¡ï¼‰
          loadVoices();
        } catch (e) {
          console.error('ä¸€é”®å…‹éš†å¤±è´¥:', e);
          out.textContent = 'ä¸€é”®å…‹éš†å¤±è´¥ï¼š' + e.message;
          out.style.color = '#f97373';
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadVoices();
      bindSaveAssistants();
      bindCloneForm();
    });
  </script>
</body>
</html>


