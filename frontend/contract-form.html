<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>åˆåŒæ‹Ÿå®š - ä¿®èŒˆç§‘æŠ€è§†é¢‘å®šåˆ¶</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“„</text></svg>" />
  <link rel="stylesheet" href="./style.css" />
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://unpkg.com/docx@8.2.2/build/index.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #1a1f2e 0%, #0d1117 100%);
      color: #e6edf3;
      min-height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
      max-width: 1920px;
      margin: 0 auto;
    }

    .form-section {
      flex: 1;
      padding: 24px 32px;
      overflow-y: auto;
      background: rgba(13, 17, 23, 0.8);
      border-right: 1px solid #30363d;
    }

    .form-header {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #58a6ff;
    }

    .form-header h1 {
      font-size: 24px;
      color: #58a6ff;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .form-header p {
      color: #8b949e;
      font-size: 14px;
      margin-top: 8px;
    }

    .form-group {
      margin-bottom: 24px;
      background: rgba(22, 27, 34, 0.6);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #30363d;
    }

    .form-group-title {
      font-size: 16px;
      color: #f0883e;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }

    .form-row {
      margin-bottom: 16px;
    }

    .form-row:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 14px;
      color: #c9d1d9;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .form-label .required {
      color: #f85149;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 10px 14px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      color: #e6edf3;
      font-size: 14px;
      transition: all 0.2s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #58a6ff;
      box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: rgba(48, 54, 61, 0.5);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .checkbox-item:hover {
      background: rgba(88, 166, 255, 0.2);
    }

    .checkbox-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #58a6ff;
    }

    .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .radio-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: rgba(48, 54, 61, 0.5);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .radio-item:hover {
      background: rgba(88, 166, 255, 0.2);
    }

    .radio-item input[type="radio"] {
      width: 16px;
      height: 16px;
      accent-color: #58a6ff;
    }

    .highlight-field {
      border-left: 3px solid #f0883e;
      padding-left: 12px;
      margin-left: -12px;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid #30363d;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #238636 0%, #2ea043 100%);
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #2ea043 0%, #3fb950 100%);
    }

    .btn-secondary {
      background: #30363d;
      color: #c9d1d9;
    }

    .btn-secondary:hover {
      background: #3d444d;
    }

    .btn-danger {
      background: linear-gradient(135deg, #da3633 0%, #f85149 100%);
      color: white;
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #f85149 0%, #ff7b72 100%);
    }

    .chat-section {
      width: 420px;
      display: flex;
      flex-direction: column;
      background: rgba(22, 27, 34, 0.95);
      border-left: 1px solid #30363d;
    }

    .chat-header {
      padding: 16px 20px;
      background: linear-gradient(135deg, #58a6ff 0%, #79c0ff 100%);
      border-bottom: 1px solid #30363d;
    }

    .chat-header h2 {
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #fff;
    }

    .chat-header p {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 4px;
      color: #fff;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message {
      max-width: 90%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.6;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.ai {
      align-self: flex-start;
      background: rgba(88, 166, 255, 0.15);
      border: 1px solid rgba(88, 166, 255, 0.3);
      color: #c9d1d9;
    }

    .message.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #238636 0%, #2ea043 100%);
      color: white;
    }

    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 6px;
    }

    .chat-input-area {
      padding: 16px 20px;
      border-top: 1px solid #30363d;
      background: rgba(13, 17, 23, 0.8);
    }

    .chat-input-wrapper {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 20px;
      color: #e6edf3;
      font-size: 14px;
      resize: none;
      min-height: 44px;
      max-height: 120px;
    }

    .chat-input:focus {
      outline: none;
      border-color: #58a6ff;
    }

    .chat-send-btn {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(135deg, #58a6ff 0%, #79c0ff 100%);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .chat-send-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(88, 166, 255, 0.4);
    }

    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: #58a6ff;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #30363d;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #3d444d;
    }

    .field-hint {
      font-size: 12px;
      color: #8b949e;
      margin-top: 4px;
    }

    .form-row.filling {
      background: rgba(88, 166, 255, 0.1);
      border-radius: 8px;
      padding: 12px;
      margin: -12px;
      border: 1px solid rgba(88, 166, 255, 0.3);
    }

    .form-row.filled .form-label::after {
      content: 'âœ“';
      color: #2ea043;
      margin-left: 8px;
      font-weight: bold;
    }

    .contract-preview {
      background: #fff;
      color: #333;
      padding: 24px;
      border-radius: 8px;
      font-family: 'Times New Roman', serif;
      font-size: 14px;
      line-height: 1.8;
      max-height: 400px;
      overflow-y: auto;
    }

    .contract-preview h2 {
      text-align: center;
      font-size: 18px;
      margin-bottom: 20px;
      border-bottom: 2px solid #333;
      padding-bottom: 10px;
    }

    .contract-preview h3 {
      font-size: 15px;
      margin-top: 16px;
      margin-bottom: 8px;
      color: #333;
    }

    .contract-preview p {
      margin-bottom: 8px;
      text-indent: 2em;
    }

    .contract-preview .signature {
      margin-top: 40px;
      display: flex;
      justify-content: space-between;
    }

    .contract-preview .signature div {
      text-align: center;
      width: 45%;
    }

    .contract-preview .signature .line {
      border-top: 1px solid #333;
      margin-top: 40px;
      padding-top: 5px;
    }

    .preview-section {
      margin-top: 24px;
      padding: 20px;
      background: rgba(22, 27, 34, 0.6);
      border-radius: 12px;
      border: 1px solid #30363d;
    }

    .preview-section h3 {
      font-size: 16px;
      color: #58a6ff;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    @media (max-width: 1200px) {
      .chat-section {
        width: 360px;
      }
    }

    @media (max-width: 900px) {
      .container {
        flex-direction: column;
      }
      .chat-section {
        width: 100%;
        height: 400px;
        border-left: none;
        border-top: 1px solid #30363d;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="form-section">
      <div class="form-header">
        <h1><i class="ph ph-file-contract"></i> ä¿®èŒˆç§‘æŠ€ Â· è§†é¢‘å®šåˆ¶åˆåŒ</h1>
        <p>å°æä¼šå¸®æ‚¨æ‹Ÿå®šåˆåŒï¼Œæ‚¨åªéœ€è¦åœ¨å³ä¾§å›ç­”ä»–çš„é—®é¢˜å³å¯</p>
      </div>

      <form id="contract-form">
        <div class="form-group">
          <div class="form-group-title"><i class="ph ph-info"></i> åˆåŒåŸºæœ¬ä¿¡æ¯</div>
          
          <div class="form-row" data-field="contract-title">
            <label class="form-label">
              <i class="ph ph-heading"></i> åˆåŒæ ‡é¢˜ <span class="required">*</span>
            </label>
            <input type="text" class="form-input" id="contract-title" placeholder="ä¾‹å¦‚ï¼šè§†é¢‘åˆ¶ä½œæœåŠ¡åˆåŒ" required>
          </div>

          <div class="form-row" data-field="contract-number">
            <label class="form-label">
              <i class="ph ph-number-square-one"></i> åˆåŒç¼–å·
            </label>
            <input type="text" class="form-input" id="contract-number" placeholder="ä¾‹å¦‚ï¼šJJ-2026-001">
          </div>

          <div class="form-row" data-field="sign-date">
            <label class="form-label">
              <i class="ph ph-calendar-check"></i> ç­¾è®¢æ—¥æœŸ <span class="required">*</span>
            </label>
            <input type="date" class="form-input" id="sign-date" required>
          </div>
        </div>

        <div class="form-group">
          <div class="form-group-title"><i class="ph ph-users"></i> åˆåŒåŒæ–¹</div>
          
          <div class="form-row" data-field="party-a">
            <label class="form-label">
              <i class="ph ph-building-office"></i> ç”²æ–¹ï¼ˆå§”æ‰˜æ–¹ï¼‰<span class="required">*</span>
            </label>
            <input type="text" class="form-input" id="party-a" placeholder="å…¬å¸å…¨ç§°" required>
          </div>

          <div class="form-row" data-field="party-a-contact">
            <label class="form-label">
              <i class="ph ph-user"></i> ç”²æ–¹è”ç³»äºº
            </label>
            <input type="text" class="form-input" id="party-a-contact" placeholder="è”ç³»äººå§“å">
          </div>

          <div class="form-row" data-field="party-a-phone">
            <label class="form-label">
              <i class="ph ph-phone"></i> ç”²æ–¹è”ç³»ç”µè¯
            </label>
            <input type="tel" class="form-input" id="party-a-phone" placeholder="è”ç³»ç”µè¯">
          </div>

          <div class="form-row" data-field="party-b">
            <label class="form-label">
              <i class="ph ph-buildings"></i> ä¹™æ–¹ï¼ˆæ‰¿æ¥æ–¹ï¼‰<span class="required">*</span>
            </label>
            <input type="text" class="form-input" id="party-b" value="æ­å·ä¿®èŒˆç§‘æŠ€æœ‰é™å…¬å¸" readonly>
          </div>

          <div class="form-row" data-field="party-b-contact">
            <label class="form-label">
              <i class="ph ph-user"></i> ä¹™æ–¹è”ç³»äºº
            </label>
            <input type="text" class="form-input" id="party-b-contact" value="åˆ˜å…ˆç”Ÿ" readonly>
          </div>
        </div>

        <div class="form-group">
          <div class="form-group-title"><i class="ph ph-video"></i> æœåŠ¡å†…å®¹</div>
          
          <div class="form-row highlight-field" data-field="service-content">
            <label class="form-label">
              <i class="ph ph-list-bullets"></i> æœåŠ¡é¡¹ç›®è¯¦æƒ… <span class="required">*</span>
            </label>
            <textarea class="form-textarea" id="service-content" placeholder="è¯·è¯¦ç»†æè¿°è§†é¢‘åˆ¶ä½œæœåŠ¡å†…å®¹ï¼ŒåŒ…æ‹¬ï¼šè§†é¢‘ç±»å‹ã€æ•°é‡ã€æ—¶é•¿ã€é£æ ¼ç­‰" required></textarea>
            <p class="field-hint">ä¾‹å¦‚ï¼šæŠ–éŸ³çŸ­è§†é¢‘åˆ¶ä½œï¼Œæ¯æœˆ8æ¡ï¼Œæ¯æ¡15-30ç§’ï¼Œæç¬‘é£æ ¼</p>
          </div>

          <div class="form-row" data-field="video-count">
            <label class="form-label">
              <i class="ph ph-video-camera"></i> è§†é¢‘æ•°é‡
            </label>
            <input type="number" class="form-input" id="video-count" placeholder="è¯·è¾“å…¥è§†é¢‘æ•°é‡">
          </div>

          <div class="form-row" data-field="video-duration">
            <label class="form-label">
              <i class="ph ph-clock"></i> å•æ¡è§†é¢‘æ—¶é•¿
            </label>
            <select class="form-select" id="video-duration">
              <option value="">è¯·é€‰æ‹©æ—¶é•¿</option>
              <option value="9-14ç§’">9-14ç§’</option>
              <option value="16-22ç§’">16-22ç§’</option>
              <option value="23-38ç§’">23-38ç§’</option>
              <option value="38-46ç§’">38-46ç§’</option>
              <option value="48-56ç§’">48-56ç§’</option>
              <option value="1åˆ†é’Ÿä»¥ä¸Š">1åˆ†é’Ÿä»¥ä¸Š</option>
            </select>
          </div>

          <div class="form-row" data-field="service-cycle">
            <label class="form-label">
              <i class="ph ph-calendar-range"></i> æœåŠ¡å‘¨æœŸ <span class="required">*</span>
            </label>
            <div style="display: flex; gap: 12px; align-items: center;">
              <input type="date" class="form-input" id="service-start" required>
              <span>è‡³</span>
              <input type="date" class="form-input" id="service-end" required>
            </div>
          </div>
        </div>

        <div class="form-group">
          <div class="form-group-title"><i class="ph ph-currency-circle-dollar"></i> è´¹ç”¨çº¦å®š</div>
          
          <div class="form-row highlight-field" data-field="total-amount">
            <label class="form-label">
              <i class="ph ph-money"></i> åˆåŒæ€»é‡‘é¢ <span class="required">*</span>
            </label>
            <input type="text" class="form-input" id="total-amount" placeholder="ä¾‹å¦‚ï¼šäººæ°‘å¸ 30,000 å…ƒ" required>
          </div>

          <div class="form-row" data-field="payment-terms">
            <label class="form-label">
              <i class="ph ph-credit-card"></i> ä»˜æ¬¾æ–¹å¼ <span class="required">*</span>
            </label>
            <div class="radio-group">
              <label class="radio-item">
                <input type="radio" name="payment-terms" value="ä¸€æ¬¡æ€§æ”¯ä»˜" checked>
                <span>ä¸€æ¬¡æ€§æ”¯ä»˜</span>
              </label>
              <label class="radio-item">
                <input type="radio" name="payment-terms" value="åˆ†æœŸæ”¯ä»˜">
                <span>åˆ†æœŸæ”¯ä»˜</span>
              </label>
              <label class="radio-item">
                <input type="radio" name="payment-terms" value="æœˆä»˜">
                <span>æœˆä»˜</span>
              </label>
              <label class="radio-item">
                <input type="radio" name="payment-terms" value="æŒ‰é¡¹ç›®è¿›åº¦æ”¯ä»˜">
                <span>æŒ‰é¡¹ç›®è¿›åº¦æ”¯ä»˜</span>
              </label>
            </div>
          </div>

          <div class="form-row" data-field="payment-detail">
            <label class="form-label">
              <i class="ph ph-note"></i> ä»˜æ¬¾è¯¦æƒ…è¯´æ˜
            </label>
            <textarea class="form-textarea" id="payment-detail" placeholder="è¯·è¯¦ç»†è¯´æ˜å„é˜¶æ®µçš„ä»˜æ¬¾æ¯”ä¾‹å’Œæ—¶é—´"></textarea>
          </div>

          <div class="form-row" data-field="deposit">
            <label class="form-label">
              <i class="ph ph-bank"></i> é¢„ä»˜æ¬¾æ¯”ä¾‹
            </label>
            <select class="form-select" id="deposit">
              <option value="">è¯·é€‰æ‹©é¢„ä»˜æ¬¾æ¯”ä¾‹</option>
              <option value="30%">30%</option>
              <option value="40%">40%</option>
              <option value="50%">50%</option>
              <option value="60%">60%</option>
              <option value="æ— é¢„ä»˜æ¬¾">æ— é¢„ä»˜æ¬¾</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <div class="form-group-title"><i class="ph ph-check-square-offset"></i> äº¤ä»˜æ ‡å‡†</div>
          
          <div class="form-row" data-field="deliverables">
            <label class="form-label">
              <i class="ph ph-package"></i> äº¤ä»˜ç‰© <span class="required">*</span>
            </label>
            <textarea class="form-textarea" id="deliverables" placeholder="è¯·åˆ—å‡ºæ‰€æœ‰äº¤ä»˜ç‰©ï¼Œå¦‚ï¼šæˆç‰‡ã€æºæ–‡ä»¶ã€å°é¢å›¾ç­‰" required></textarea>
          </div>

          <div class="form-row" data-field="revision-times">
            <label class="form-label">
              <i class="ph ph-arrow-counter-clockwise"></i> å…è´¹ä¿®æ”¹æ¬¡æ•°
            </label>
            <select class="form-select" id="revision-times">
              <option value="">è¯·é€‰æ‹©</option>
              <option value="1æ¬¡">1æ¬¡</option>
              <option value="2æ¬¡">2æ¬¡</option>
              <option value="3æ¬¡">3æ¬¡</option>
              <option value="5æ¬¡">5æ¬¡</option>
              <option value="ä¸é™æ¬¡æ•°">ä¸é™æ¬¡æ•°</option>
            </select>
          </div>

          <div class="form-row" data-field="delivery-time">
            <label class="form-label">
              <i class="ph ph-timer"></i> äº¤ä»˜æ—¶é—´ï¼ˆå•æ¡ï¼‰
            </label>
            <input type="text" class="form-input" id="delivery-time" placeholder="ä¾‹å¦‚ï¼šåˆç¨¿3ä¸ªå·¥ä½œæ—¥å†…">
          </div>
        </div>

        <div class="form-group">
          <div class="form-group-title"><i class="ph ph-shield-check"></i> æƒåˆ©ä¸ä¹‰åŠ¡</div>
          
          <div class="form-row" data-field="copyright">
            <label class="form-label">
              <i class="ph ph-copyright"></i> ç‰ˆæƒå½’å± <span class="required">*</span>
            </label>
            <div class="radio-group">
              <label class="radio-item">
                <input type="radio" name="copyright" value="ç”²æ–¹æ‰€æœ‰" checked>
                <span>ç”²æ–¹æ‰€æœ‰</span>
              </label>
              <label class="radio-item">
                <input type="radio" name="copyright" value="ä¹™æ–¹æ‰€æœ‰">
                <span>ä¹™æ–¹æ‰€æœ‰</span>
              </label>
              <label class="radio-item">
                <input type="radio" name="copyright" value="åŒæ–¹å…±æœ‰">
                <span>åŒæ–¹å…±æœ‰</span>
              </label>
            </div>
          </div>

          <div class="form-row" data-field="confidentiality">
            <label class="form-label">
              <i class="ph ph-lock-key"></i> ä¿å¯†æ¡æ¬¾
            </label>
            <div class="checkbox-group">
              <label class="checkbox-item">
                <input type="checkbox" name="confidentiality" value="åŒæ–¹äº’ç›¸ä¿å¯†" checked>
                <span>åŒæ–¹äº’ç›¸ä¿å¯†</span>
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="confidentiality" value="ç´ æä¿å¯†">
                <span>ç´ æä¿å¯†</span>
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="confidentiality" value="ä»·æ ¼ä¿å¯†">
                <span>ä»·æ ¼ä¿å¯†</span>
              </label>
            </div>
          </div>

          <div class="form-row" data-field="dispute-resolution">
            <label class="form-label">
              <i class="ph ph-scales"></i> äº‰è®®è§£å†³
            </label>
            <select class="form-select" id="dispute-resolution">
              <option value="">è¯·é€‰æ‹©</option>
              <option value="ç”²æ–¹æ‰€åœ¨åœ°æ³•é™¢">ç”²æ–¹æ‰€åœ¨åœ°æ³•é™¢</option>
              <option value="ä¹™æ–¹æ‰€åœ¨åœ°æ³•é™¢">ä¹™æ–¹æ‰€åœ¨åœ°æ³•é™¢</option>
              <option value="æ­å·ä»²è£å§”å‘˜ä¼š">æ­å·ä»²è£å§”å‘˜ä¼š</option>
              <option value="åŒæ–¹åå•†è§£å†³">åŒæ–¹åå•†è§£å†³</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <div class="form-group-title"><i class="ph ph-note-pencil"></i> è¡¥å……æ¡æ¬¾</div>
          
          <div class="form-row" data-field="additional-terms">
            <label class="form-label">
              <i class="ph ph-list-plus"></i> å…¶ä»–çº¦å®š
            </label>
            <textarea class="form-textarea" id="additional-terms" placeholder="å¦‚æœ‰å…¶ä»–ç‰¹æ®Šçº¦å®šï¼Œè¯·åœ¨æ­¤è¯´æ˜"></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-primary" id="generate-preview">
            <i class="ph ph-eye"></i> ç”Ÿæˆé¢„è§ˆ
          </button>
          <button type="button" class="btn btn-secondary" id="save-draft">
            <i class="ph ph-floppy-disk"></i> ä¿å­˜è‰ç¨¿
          </button>
          <button type="button" class="btn btn-primary" id="export-word">
            <i class="ph ph-file-doc"></i> å¯¼å‡ºWord
          </button>
          <button type="button" class="btn btn-secondary" id="reset-form">
            <i class="ph ph-arrow-counter-clockwise"></i> é‡ç½®
          </button>
        </div>

        <div class="preview-section" id="preview-section" style="display: none;">
          <h3><i class="ph ph-file-text"></i> åˆåŒé¢„è§ˆ</h3>
          <div class="contract-preview" id="contract-preview">
            <!-- åˆåŒå†…å®¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
      </form>
    </div>

    <div class="chat-section">
      <div class="chat-header">
        <h2><i class="ph ph-user-circle"></i> å°æ - åˆåŒä¸“å‘˜</h2>
        <p>æˆ‘ä¼šå¼•å¯¼æ‚¨å®ŒæˆåˆåŒæ‹Ÿå®šï¼Œè¯·ç›´æ¥å›ç­”æˆ‘çš„é—®é¢˜</p>
        <div style="margin-top: 8px; font-size: 11px; opacity: 0.8; display: flex; align-items: center; gap: 6px;">
          <i class="ph ph-robot"></i>
          <span id="ai-model-name">æ­£åœ¨åŠ è½½AIé…ç½®...</span>
        </div>
      </div>

      <div class="chat-messages" id="chat-messages">
      </div>

      <div class="chat-input-area">
        <div style="display: flex; gap: 8px; margin-bottom: 10px; align-items: center;">
          <button class="voice-btn" id="voice-toggle" onclick="toggleVoice()" title="å¼€å¯/å…³é—­è¯­éŸ³æ’­æŠ¥">
            <i class="ph ph-speaker-high"></i>
            <span>è¯­éŸ³æ’­æŠ¥ï¼šå¼€</span>
          </button>
          <span id="voice-status" style="font-size: 12px; color: #8b949e; margin-left: auto;"></span>
        </div>
        <div class="chat-input-wrapper">
          <textarea class="chat-input" id="chat-input" placeholder="è¾“å…¥æ‚¨çš„å›ç­”..." rows="1"></textarea>
          <button class="chat-send-btn" id="send-btn" onclick="sendMessage()">
            <i class="ph ph-paper-plane-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    .voice-btn {
      padding: 6px 12px;
      background: rgba(88, 166, 255, 0.1);
      border: 1px solid rgba(88, 166, 255, 0.3);
      border-radius: 16px;
      color: #58a6ff;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .voice-btn:hover {
      background: rgba(88, 166, 255, 0.2);
    }
    .voice-btn.active {
      background: rgba(88, 166, 255, 0.3);
      border-color: #58a6ff;
    }
  </style>

  <script>
    let voiceEnabled = true;
    let currentAudio = null;
    let recognition = null;
    let isRecording = false;

    function initSpeechRecognition() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'zh-CN';
        recognition.continuous = false;
        recognition.interimResults = false;
        
        recognition.onstart = function() {
          isRecording = true;
          updateVoiceInputUI();
          document.getElementById('voice-status').textContent = 'æ­£åœ¨è†å¬...';
        };
        
        recognition.onend = function() {
          isRecording = false;
          updateVoiceInputUI();
          document.getElementById('voice-status').textContent = '';
        };
        
        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          chatInput.value = transcript;
          chatInput.style.height = 'auto';
          chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
          setTimeout(() => {
            sendMessage();
          }, 500);
        };
        
        recognition.onerror = function(event) {
          console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
          document.getElementById('voice-status').textContent = 'è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•';
          isRecording = false;
        };
        
        return true;
      } else {
        document.getElementById('voice-status').textContent = 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥';
        return false;
      }
    }

    function toggleVoice() {
      voiceEnabled = !voiceEnabled;
      const btn = document.getElementById('voice-toggle');
      const icon = btn.querySelector('i');
      const text = btn.querySelector('span');
      
      if (voiceEnabled) {
        btn.classList.add('active');
        icon.className = 'ph ph-speaker-high';
        text.textContent = 'è¯­éŸ³æ’­æŠ¥ï¼šå¼€';
        speak('è¯­éŸ³æ’­æŠ¥å·²å¼€å¯');
      } else {
        btn.classList.remove('active');
        icon.className = 'ph ph-speaker-slash';
        text.textContent = 'è¯­éŸ³æ’­æŠ¥ï¼šå…³';
        if (currentAudio) {
          try { currentAudio.pause(); } catch (e) {}
          currentAudio = null;
        }
      }
    }

    async function speak(text) {
      if (!voiceEnabled || !text || !text.trim()) return;

      if (currentAudio) {
        try { currentAudio.pause(); } catch (e) {}
        currentAudio = null;
      }

      try {
        const resp = await fetch('http://localhost:8080/api/tts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: text, lang: 'zh' })
        });

        const result = await resp.json();
        if (!resp.ok || result.success === false) {
          const msg = result && result.error && result.error.message ? result.error.message : 'TTSè¯·æ±‚å¤±è´¥';
          throw new Error(msg);
        }
        const data = result.data || {};
        if (!data.audioBase64) {
          throw new Error('æ— éŸ³é¢‘æ•°æ®');
        }

        const audio = new Audio(data.audioBase64);
        currentAudio = audio;
        audio.play().catch((e) => { 
          console.error('æ’­æ”¾å¤±è´¥ï¼Œå°è¯•æµè§ˆå™¨è¯­éŸ³:', e);
          speakWithBrowser(text);
        });
      } catch (e) {
        console.log('TTSä¸å¯ç”¨ï¼Œä½¿ç”¨æµè§ˆå™¨è¯­éŸ³åˆæˆ');
        speakWithBrowser(text);
      }
    }

    function speakWithBrowser(text) {
      if (!voiceEnabled || !text) return;
      
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-CN';
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        
        const voices = window.speechSynthesis.getVoices();
        const chineseVoice = voices.find(v => v.lang.includes('zh')) || voices[0];
        if (chineseVoice) {
          utterance.voice = chineseVoice;
        }
        
        window.speechSynthesis.speak(utterance);
      }
    }

    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const CONTRACT_NODE_ID = 'douyin-client-need';

    function getAIConfig() {
      let orgNodeModels = {};
      let apiConfigs = {};
      
      try {
        const storedNodeModels = localStorage.getItem('orgNodeModels');
        orgNodeModels = storedNodeModels ? JSON.parse(storedNodeModels) : {};
        
        const storedApiConfigs = localStorage.getItem('aiApiConfigs');
        apiConfigs = storedApiConfigs ? JSON.parse(storedApiConfigs) : {};
      } catch (e) {
        console.log('è·å–AIé…ç½®å¤±è´¥:', e);
      }

      const nodeConfig = orgNodeModels[CONTRACT_NODE_ID] || orgNodeModels['douyin-client'];
      
      if (nodeConfig && nodeConfig.provider && nodeConfig.model) {
        return {
          provider: nodeConfig.provider,
          model: nodeConfig.model,
          apiKey: apiConfigs[nodeConfig.provider] || '',
          isModuleSpecific: true
        };
      }

      let selectedModel = localStorage.getItem('selectedModel') || 'qwen-max';
      let provider = 'qwen';
      let model = selectedModel;
      
      if (selectedModel && selectedModel.includes(':')) {
        [provider, model] = selectedModel.split(':');
      }
      
      return { provider, model, apiKey: apiConfigs[provider] || '', isModuleSpecific: false };
    }

    function displayAIModelInfo() {
      const config = getAIConfig();
      const modelNameEl = document.getElementById('ai-model-name');
      
      if (modelNameEl) {
        if (config.isModuleSpecific) {
          modelNameEl.textContent = `åˆåŒæ‹Ÿå®šä¸“ç”¨: ${config.provider} Â· ${config.model}`;
          modelNameEl.style.color = '#58a6ff';
        } else {
          modelNameEl.textContent = `ä½¿ç”¨å…¨å±€é…ç½®: ${config.provider} Â· ${config.model}`;
          modelNameEl.style.color = '#fff';
        }
      }
    }

    async function callAI(messages) {
      const config = getAIConfig();
      
      try {
        const response = await fetch('http://localhost:8080/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            provider: config.provider,
            model: config.model,
            messages: messages,
            apiKey: config.apiKey,
            source: 'contract-form'
          })
        });
        
        const result = await response.json();
        if (!response.ok || result.success === false) {
          const msg = result && result.error && result.error.message ? result.error.message : response.statusText;
          throw new Error('AIè¯·æ±‚å¤±è´¥: ' + msg);
        }
        
        const data = result.data || {};
        return data.content || data.message || 'æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰ç†è§£ï¼Œè¯·å†è¯´ä¸€éã€‚';
      } catch (error) {
        console.error('AIè°ƒç”¨å¤±è´¥:', error);
        addMessage('âš ï¸ AIè¿æ¥å¤±è´¥: ' + error.message + 'ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨ï¼Œæˆ–åœ¨æ§åˆ¶å°æŸ¥çœ‹è¯¦æƒ…', 'ai');
        return null;
      }
    }

    function buildSystemPrompt() {
      return `ä½ ç°åœ¨æ‰®æ¼”ä¸€åã€ŒåˆåŒä¸“å‘˜å°æã€ï¼Œä¸“é—¨è´Ÿè´£ä¸ºä¿®èŒˆç§‘æŠ€è§†é¢‘å®šåˆ¶å…¬å¸æ‹Ÿå®šè§†é¢‘åˆ¶ä½œæœåŠ¡åˆåŒã€‚

ã€ä½ çš„èŒè´£ã€‘
- ç†Ÿæ‚‰è§†é¢‘åˆ¶ä½œæœåŠ¡è¡Œä¸šçš„åˆåŒè§„èŒƒ
- ä¸¥æ ¼æŒ‰ç…§æ³•å¾‹è¦æ±‚æ‹Ÿå®šåˆåŒæ¡æ¬¾
- ä¿æŠ¤åŒæ–¹æƒç›Šï¼Œæ¡æ¬¾æ¸…æ™°åˆç†
- è¯­æ°”ä¸“ä¸šã€ä¸¥è°¨ã€ç¤¼è²Œ

ã€å½“å‰ä»»åŠ¡ - åˆåŒæ‹Ÿå®šã€‘
ä½ éœ€è¦å¼•å¯¼å®¢æˆ·å¡«å†™åˆåŒä¿¡æ¯ï¼Œæ”¶é›†ä»¥ä¸‹å†…å®¹ï¼š
1. åˆåŒæ ‡é¢˜ï¼ˆå¦‚ï¼šè§†é¢‘åˆ¶ä½œæœåŠ¡åˆåŒï¼‰
2. ç­¾è®¢æ—¥æœŸ
3. ç”²æ–¹ä¿¡æ¯ï¼ˆå§”æ‰˜æ–¹å…¬å¸å…¨ç§°ã€è”ç³»äººã€ç”µè¯ï¼‰
4. ä¹™æ–¹ä¿¡æ¯ï¼ˆå·²å›ºå®šä¸ºï¼šæ­å·ä¿®èŒˆç§‘æŠ€æœ‰é™å…¬å¸ï¼‰
5. æœåŠ¡å†…å®¹è¯¦æƒ…ï¼ˆè§†é¢‘ç±»å‹ã€æ•°é‡ã€æ—¶é•¿ã€é£æ ¼ï¼‰
6. æœåŠ¡å‘¨æœŸï¼ˆå¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸï¼‰
7. åˆåŒæ€»é‡‘é¢
8. ä»˜æ¬¾æ–¹å¼ï¼ˆä¸€æ¬¡æ€§/åˆ†æœŸ/æœˆä»˜/æŒ‰è¿›åº¦ï¼‰
9. äº¤ä»˜ç‰©æ¸…å•ï¼ˆæˆç‰‡ã€æºæ–‡ä»¶ã€å°é¢ç­‰ï¼‰
10. å…è´¹ä¿®æ”¹æ¬¡æ•°
11. ç‰ˆæƒå½’å±
12. äº‰è®®è§£å†³æ–¹å¼

ã€å¯¹è¯è¦æ±‚ã€‘
- è¯­æ°”ä¸“ä¸šã€ä¸¥è°¨ã€æœ‰è€å¿ƒ
- æ¯æ¬¡åªé—®1-2ä¸ªé—®é¢˜ï¼Œç­‰å¾…å®¢æˆ·å›ç­”åå†ç»§ç»­
- å¦‚æœå®¢æˆ·å›ç­”ä¸å¤Ÿæ¸…æ™°ï¼Œå‹å–„åœ°è¿½é—®
- é€‚æ—¶è§£é‡Šç›¸å…³æ¡æ¬¾çš„æ„ä¹‰
- ä¿æŒå¯¹è¯æµç•…è‡ªç„¶

ã€å›ç­”é£æ ¼ã€‘
- ç”¨ã€Œç¡®è®¤æ”¶åˆ° â†’ ç®€è¦å›åº” â†’ è‡ªç„¶è¿‡æ¸¡ â†’ ä¸‹ä¸€ä¸ªé—®é¢˜ã€çš„ç»“æ„
- é€‚å½“ä½¿ç”¨ä¸“ä¸šæœ¯è¯­ï¼Œå±•ç¤ºä¸“ä¸šæ€§`;
    }

    let conversationHistory = [
      { role: 'system', content: buildSystemPrompt() }
    ];

    const fieldMappings = {
      'contract-title': { name: 'åˆåŒæ ‡é¢˜', type: 'text' },
      'party-a': { name: 'ç”²æ–¹å…¬å¸', type: 'text' },
      'party-a-contact': { name: 'ç”²æ–¹è”ç³»äºº', type: 'text' },
      'party-a-phone': { name: 'ç”²æ–¹ç”µè¯', type: 'text' },
      'service-content': { name: 'æœåŠ¡å†…å®¹', type: 'text' },
      'video-count': { name: 'è§†é¢‘æ•°é‡', type: 'text' },
      'video-duration': { name: 'è§†é¢‘æ—¶é•¿', type: 'select' },
      'service-start': { name: 'æœåŠ¡å¼€å§‹æ—¥æœŸ', type: 'text' },
      'service-end': { name: 'æœåŠ¡ç»“æŸæ—¥æœŸ', type: 'text' },
      'total-amount': { name: 'åˆåŒé‡‘é¢', type: 'text' },
      'payment-terms': { name: 'ä»˜æ¬¾æ–¹å¼', type: 'radio' },
      'deliverables': { name: 'äº¤ä»˜ç‰©', type: 'text' },
      'revision-times': { name: 'ä¿®æ”¹æ¬¡æ•°', type: 'select' },
      'copyright': { name: 'ç‰ˆæƒå½’å±', type: 'radio' }
    };

    function highlightField(fieldId) {
      document.querySelectorAll('.form-row').forEach(row => {
        row.classList.remove('filling');
      });
      
      if (fieldId) {
        const row = document.querySelector(`[data-field="${fieldId}"]`);
        if (row) {
          row.classList.add('filling');
          row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }

    function markFieldFilled(fieldId) {
      const row = document.querySelector(`[data-field="${fieldId}"]`);
      if (row) {
        row.classList.remove('filling');
        row.classList.add('filled');
      }
    }

    async function initXiaoLi() {
      conversationHistory.push({
        role: 'user',
        content: 'è¯·å¼€å§‹å¯¹è¯ï¼Œå‘å®¢æˆ·æ‰“æ‹›å‘¼å¹¶è¯¢é—®åˆåŒæ ‡é¢˜ã€‚'
      });
      
      showTypingIndicator();
      const aiResponse = await callAI(conversationHistory);
      hideTypingIndicator();
      
      if (aiResponse) {
        conversationHistory.push({ role: 'assistant', content: aiResponse });
        addMessage(aiResponse, 'ai');
        extractAndFillForm(aiResponse);
      } else {
        const defaultGreeting = 'æ‚¨å¥½ï¼æˆ‘æ˜¯å°æï¼Œä¿®èŒˆç§‘æŠ€è§†é¢‘å®šåˆ¶çš„åˆåŒä¸“å‘˜ ğŸ˜Š\n\nå¾ˆé«˜å…´ä¸ºæ‚¨æ‹Ÿå®šåˆåŒï¼è¯·é—®æˆ‘ä»¬è¿™ä»½åˆåŒè¦æ‹Ÿå®šçš„æ ‡é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ';
        addMessage(defaultGreeting, 'ai');
        conversationHistory.push({ role: 'assistant', content: defaultGreeting });
      }
    }

    function extractAndFillForm(aiText) {
      const emptyFields = Object.keys(fieldMappings).filter(fieldId => {
        const field = document.getElementById(fieldId);
        return field && !field.value;
      });
      
      if (emptyFields.length > 0) {
        highlightField(emptyFields[0]);
      }
    }

    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;
      
      addMessage(message, 'user');
      chatInput.value = '';
      chatInput.style.height = 'auto';
      
      await processUserAnswer(message);
    }

    async function processUserAnswer(answer) {
      conversationHistory.push({ role: 'user', content: answer });
      
      const currentFormData = collectFormData();
      const filledFields = Object.entries(currentFormData)
        .filter(([key, value]) => value && value !== '')
        .map(([key, value]) => `${key}: ${value}`);
      
      const progressPrompt = `å®¢æˆ·åˆšåˆšå›ç­”ï¼š"${answer}"

å½“å‰å·²æ”¶é›†çš„ä¿¡æ¯ï¼š
${filledFields.length > 0 ? filledFields.join('\n') : 'æš‚æ— '}

è¯·æ ¹æ®å®¢æˆ·çš„å›ç­”ï¼š
1. ç¡®è®¤æ”¶åˆ°ä¿¡æ¯å¹¶ç®€è¦å›åº”
2. è‡ªç„¶åœ°å¼•å¯¼åˆ°ä¸‹ä¸€ä¸ªéœ€è¦æ”¶é›†çš„ä¿¡æ¯
3. å¦‚æœä¿¡æ¯ä¸å®Œæ•´ï¼Œå‹å–„åœ°è¿½é—®

è¯·ç›´æ¥å›å¤å®¢æˆ·ï¼ˆä¸è¦æš´éœ²ç³»ç»Ÿæç¤ºï¼‰ã€‚`;
      
      conversationHistory.push({ role: 'user', content: progressPrompt });
      
      showTypingIndicator();
      const aiResponse = await callAI(conversationHistory);
      hideTypingIndicator();
      
      if (aiResponse) {
        conversationHistory.push({ role: 'assistant', content: aiResponse });
        addMessage(aiResponse, 'ai');
        smartFillForm(answer, aiResponse);
      } else {
        addMessage('æ”¶åˆ°ï¼è¯·ç»§ç»­å‘Šè¯‰æˆ‘æ›´å¤šä¿¡æ¯ã€‚', 'ai');
      }
    }

    function smartFillForm(userAnswer, aiResponse) {
      const answer = userAnswer.toLowerCase();
      
      if (!document.getElementById('contract-title').value && userAnswer.length < 50) {
        document.getElementById('contract-title').value = userAnswer;
        markFieldFilled('contract-title');
        return;
      }
      
      if (!document.getElementById('party-a').value && userAnswer.length < 50) {
        document.getElementById('party-a').value = userAnswer;
        markFieldFilled('party-a');
        return;
      }
      
      if (!document.getElementById('party-a-contact').value && userAnswer.length < 20) {
        document.getElementById('party-a-contact').value = userAnswer;
        markFieldFilled('party-a-contact');
        return;
      }
      
      if (!document.getElementById('service-content').value && userAnswer.length > 10) {
        document.getElementById('service-content').value = userAnswer;
        markFieldFilled('service-content');
        return;
      }
      
      if (!document.getElementById('total-amount').value && (answer.includes('å…ƒ') || answer.includes('åƒ') || answer.includes('ä¸‡'))) {
        document.getElementById('total-amount').value = userAnswer;
        markFieldFilled('total-amount');
        return;
      }
      
      const emptyFields = Object.keys(fieldMappings).filter(fieldId => {
        const field = document.getElementById(fieldId);
        return field && !field.value;
      });
      
      if (emptyFields.length > 0) {
        highlightField(emptyFields[0]);
      }
    }

    function addMessage(content, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.innerHTML = `
        <div style="white-space: pre-line;">${content}</div>
        <div class="message-time">${new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}</div>
      `;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      if (type === 'ai') {
        const plainText = content.replace(/[ğŸ˜ŠğŸ‰âœ…ğŸ‘ğŸ’¡]/g, '').replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
        speak(plainText);
      }
    }

    function showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message ai typing';
      typingDiv.id = 'typing-indicator';
      typingDiv.innerHTML = `
        <div class="typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
      `;
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTypingIndicator() {
      const typingIndicator = document.getElementById('typing-indicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    chatInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    chatInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    function collectFormData() {
      const data = {
        contractTitle: document.getElementById('contract-title').value,
        contractNumber: document.getElementById('contract-number').value,
        signDate: document.getElementById('sign-date').value,
        partyA: document.getElementById('party-a').value,
        partyAContact: document.getElementById('party-a-contact').value,
        partyAPhone: document.getElementById('party-a-phone').value,
        partyB: document.getElementById('party-b').value,
        partyBContact: document.getElementById('party-b-contact').value,
        serviceContent: document.getElementById('service-content').value,
        videoCount: document.getElementById('video-count').value,
        videoDuration: document.getElementById('video-duration').value,
        serviceStart: document.getElementById('service-start').value,
        serviceEnd: document.getElementById('service-end').value,
        totalAmount: document.getElementById('total-amount').value,
        paymentTerms: document.querySelector('input[name="payment-terms"]:checked')?.value,
        paymentDetail: document.getElementById('payment-detail').value,
        deposit: document.getElementById('deposit').value,
        deliverables: document.getElementById('deliverables').value,
        revisionTimes: document.getElementById('revision-times').value,
        deliveryTime: document.getElementById('delivery-time').value,
        copyright: document.querySelector('input[name="copyright"]:checked')?.value,
        disputeResolution: document.getElementById('dispute-resolution').value,
        additionalTerms: document.getElementById('additional-terms').value
      };
      return data;
    }

    function generateContractPreview() {
      const data = collectFormData();
      
      const html = `
        <h2>${data.contractTitle || 'è§†é¢‘åˆ¶ä½œæœåŠ¡åˆåŒ'}</h2>
        <p><strong>åˆåŒç¼–å·ï¼š</strong>${data.contractNumber || '___'}</p>
        <p><strong>ç­¾è®¢æ—¥æœŸï¼š</strong>${data.signDate || '___'}</p>
        
        <h3>ä¸€ã€åˆåŒåŒæ–¹</h3>
        <p>ç”²æ–¹ï¼ˆå§”æ‰˜æ–¹ï¼‰ï¼š${data.partyA || '___'}</p>
        <p>ç”²æ–¹è”ç³»äººï¼š${data.partyAContact || '___'}</p>
        <p>ç”²æ–¹è”ç³»ç”µè¯ï¼š${data.partyAPhone || '___'}</p>
        <p>ä¹™æ–¹ï¼ˆæ‰¿æ¥æ–¹ï¼‰ï¼š${data.partyB || 'æ­å·ä¿®èŒˆç§‘æŠ€æœ‰é™å…¬å¸'}</p>
        <p>ä¹™æ–¹è”ç³»äººï¼š${data.partyBContact || 'åˆ˜å…ˆç”Ÿ'}</p>
        
        <h3>äºŒã€æœåŠ¡å†…å®¹</h3>
        <p>${data.serviceContent || '___'}</p>
        <p>è§†é¢‘æ•°é‡ï¼š${data.videoCount || '___'}æ¡</p>
        <p>å•æ¡æ—¶é•¿ï¼š${data.videoDuration || '___'}</p>
        <p>æœåŠ¡å‘¨æœŸï¼š${data.serviceStart || '___'} è‡³ ${data.serviceEnd || '___'}</p>
        
        <h3>ä¸‰ã€è´¹ç”¨åŠä»˜æ¬¾</h3>
        <p>åˆåŒæ€»é‡‘é¢ï¼š${data.totalAmount || '___'}</p>
        <p>ä»˜æ¬¾æ–¹å¼ï¼š${data.paymentTerms || '___'}</p>
        <p>${data.paymentDetail || ''}</p>
        <p>é¢„ä»˜æ¬¾æ¯”ä¾‹ï¼š${data.deposit || '___'}</p>
        
        <h3>å››ã€äº¤ä»˜æ ‡å‡†</h3>
        <p>äº¤ä»˜ç‰©ï¼š${data.deliverables || '___'}</p>
        <p>å…è´¹ä¿®æ”¹æ¬¡æ•°ï¼š${data.revisionTimes || '___'}</p>
        <p>äº¤ä»˜æ—¶é—´ï¼š${data.deliveryTime || '___'}</p>
        
        <h3>äº”ã€æƒåˆ©ä¸ä¹‰åŠ¡</h3>
        <p>ç‰ˆæƒå½’å±ï¼š${data.copyright || '___'}</p>
        <p>äº‰è®®è§£å†³ï¼š${data.disputeResolution || '___'}</p>
        
        <h3>å…­ã€è¡¥å……æ¡æ¬¾</h3>
        <p>${data.additionalTerms || 'æ— '}</p>
        
        <div class="signature">
          <div>
            <p>ç”²æ–¹ï¼ˆç›–ç« ï¼‰ï¼š</p>
            <div class="line">ç­¾å­—ï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æ—¥æœŸï¼š</div>
          </div>
          <div>
            <p>ä¹™æ–¹ï¼ˆç›–ç« ï¼‰ï¼š</p>
            <div class="line">ç­¾å­—ï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æ—¥æœŸï¼š</div>
          </div>
        </div>
      `;
      
      document.getElementById('contract-preview').innerHTML = html;
      document.getElementById('preview-section').style.display = 'block';
      document.getElementById('preview-section').scrollIntoView({ behavior: 'smooth' });
    }

    document.getElementById('generate-preview').addEventListener('click', generateContractPreview);

    document.getElementById('export-word').addEventListener('click', async function() {
      const data = collectFormData();
      
      if (!data.contractTitle || !data.partyA || !data.serviceContent || !data.totalAmount) {
        alert('è¯·å…ˆå¡«å†™å¿…è¦çš„åˆåŒä¿¡æ¯ï¼ˆåˆåŒæ ‡é¢˜ã€ç”²æ–¹ã€æœåŠ¡å†…å®¹ã€åˆåŒé‡‘é¢ï¼‰');
        return;
      }

      const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType, Table, TableRow, TableCell, WidthType, BorderStyle } = docx;

      const tableStyle = {
        indentation: { left: 720, type: WidthType.DXA },
      };

      const children = [
        new Paragraph({
          text: data.contractTitle || 'è§†é¢‘åˆ¶ä½œæœåŠ¡åˆåŒ',
          heading: HeadingLevel.TITLE,
          alignment: AlignmentType.CENTER,
          spacing: { after: 200 },
        }),
        new Paragraph({
          children: [
            new TextRun({ text: 'åˆåŒç¼–å·ï¼š', bold: true }),
            new TextRun({ text: data.contractNumber || '___________' }),
            new TextRun({ text: '          ç­¾è®¢æ—¥æœŸï¼š', bold: true }),
            new TextRun({ text: data.signDate || '___________' }),
          ],
          spacing: { after: 200 },
        }),
        new Paragraph({
          text: 'ä¸€ã€åˆåŒåŒæ–¹',
          heading: HeadingLevel.HEADING_1,
          spacing: { before: 200, after: 100 },
        }),
        new Paragraph({
          children: [
            new TextRun({ text: 'ç”²æ–¹ï¼ˆå§”æ‰˜æ–¹ï¼‰ï¼š', bold: true }),
            new TextRun({ text: data.partyA || '___________' }),
          ],
        }),
        new Paragraph({
          children: [
            new TextRun({ text: 'ç”²æ–¹è”ç³»äººï¼š', bold: true }),
            new TextRun({ text: data.partyAContact || '___________' }),
            new TextRun({ text: '          è”ç³»ç”µè¯ï¼š', bold: true }),
            new TextRun({ text: data.partyAPhone || '___________' }),
          ],
          spacing: { after: 100 },
        }),
        new Paragraph({
          children: [
            new TextRun({ text: 'ä¹™æ–¹ï¼ˆæ‰¿æ¥æ–¹ï¼‰ï¼š', bold: true }),
            new TextRun({ text: data.partyB || 'æ­å·ä¿®èŒˆç§‘æŠ€æœ‰é™å…¬å¸' }),
          ],
        }),
        new Paragraph({
          children: [
            new TextRun({ text: 'ä¹™æ–¹è”ç³»äººï¼š', bold: true }),
            new TextRun({ text: data.partyBContact || 'åˆ˜å…ˆç”Ÿ' }),
          ],
          spacing: { after: 200 },
        }),
        new Paragraph({
          text: 'äºŒã€æœåŠ¡å†…å®¹',
          heading: HeadingLevel.HEADING_1,
          spacing: { before: 200, after: 100 },
        }),
        new Paragraph({
          text: data.serviceContent || '___________',
        }),
        new Paragraph({
          children: [
            new TextRun({ text: 'è§†é¢‘æ•°é‡ï¼š', bold: true }),
            new TextRun({ text: data.videoCount || '___________' }),
            new TextRun({ text: 'æ¡          å•æ¡æ—¶é•¿ï¼š', bold: true }),
            new TextRun({ text: data.videoDuration || '___________' }),
          ],
          spacing: { after: 100 },
        }),
        new Paragraph({
          children: [
            new TextRun({ text: 'æœåŠ¡å‘¨æœŸï¼š', bold: true }),
            new TextRun({ text: (data.serviceStart || '___________') + ' è‡³ ' + (data.serviceEnd || '___________') }),
          ],
          spacing: { after: 200 },
        }),
        new Paragraph({
          text: 'ä¸‰ã€è´¹ç”¨åŠä»˜æ¬¾',
          heading: HeadingLevel.HEADING_1,
          spacing: { before: 200, after: 100 },
        }),
        new Paragraph({
          children: [
            new TextRun({ text: 'åˆåŒæ€»é‡‘é¢ï¼š', bold: true }),
            new TextRun({ text: data.totalAmount || '___________' }),
          ],
        }),
        new Paragraph({
          children: [
            new TextRun({ text: 'ä»˜æ¬¾æ–¹å¼ï¼š', bold: true }),
            new TextRun({ text: data.paymentTerms || '___________' }),
          ],
          spacing: { after: 100 },
        }),
        new Paragraph({
          text: data.paymentDetail || '',
          spacing: { after: 100 },
        }),
        new Paragraph({
          children: [
            new TextRun({ text: 'é¢„ä»˜æ¬¾æ¯”ä¾‹ï¼š', bold: true }),
            new TextRun({ text: data.deposit || '___________' }),
          ],
          spacing: { after: 200 },
        }),
        new Paragraph({
          text: 'å››ã€äº¤ä»˜æ ‡å‡†',
          heading: HeadingLevel.HEADING_1,
          spacing: { before: 200, after: 100 },
        }),
        new Paragraph({
          children: [
            new TextRun({ text: 'äº¤ä»˜ç‰©ï¼š', bold: true }),
            new TextRun({ text: data.deliverables || '___________' }),
          ],
        }),
        new Paragraph({
          children: [
            new TextRun({ text: 'å…è´¹ä¿®æ”¹æ¬¡æ•°ï¼š', bold: true }),
            new TextRun({ text: data.revisionTimes || '___________' }),
          ],
          spacing: { after: 100 },
        }),
        new Paragraph({
          children: [
            new TextRun({ text: 'äº¤ä»˜æ—¶é—´ï¼š', bold: true }),
            new TextRun({ text: data.deliveryTime || '___________' }),
          ],
          spacing: { after: 200 },
        }),
        new Paragraph({
          text: 'äº”ã€æƒåˆ©ä¸ä¹‰åŠ¡',
          heading: HeadingLevel.HEADING_1,
          spacing: { before: 200, after: 100 },
        }),
        new Paragraph({
          children: [
            new TextRun({ text: 'ç‰ˆæƒå½’å±ï¼š', bold: true }),
            new TextRun({ text: data.copyright || '___________' }),
          ],
        }),
        new Paragraph({
          children: [
            new TextRun({ text: 'äº‰è®®è§£å†³ï¼š', bold: true }),
            new TextRun({ text: data.disputeResolution || '___________' }),
          ],
          spacing: { after: 200 },
        }),
      ];

      if (data.additionalTerms) {
        children.push(
          new Paragraph({
            text: 'å…­ã€è¡¥å……æ¡æ¬¾',
            heading: HeadingLevel.HEADING_1,
            spacing: { before: 200, after: 100 },
          }),
          new Paragraph({
            text: data.additionalTerms,
            spacing: { after: 200 },
          })
        );
      }

      children.push(
        new Paragraph({
          text: '',
          spacing: { before: 400, after: 200 },
        }),
        new Table({
          rows: [
            new TableRow({
              children: [
                new TableCell({
                  children: [new Paragraph({ children: [new TextRun({ text: 'ç”²æ–¹ï¼ˆç›–ç« ï¼‰', bold: true })] })],
                  width: { size: 50, type: WidthType.PERCENTAGE },
                }),
                new TableCell({
                  children: [new Paragraph({ children: [new TextRun({ text: 'ä¹™æ–¹ï¼ˆç›–ç« ï¼‰', bold: true })] })],
                  width: { size: 50, type: WidthType.PERCENTAGE },
                }),
              ],
            }),
            new TableRow({
              children: [
                new TableCell({
                  children: [
                    new Paragraph('ç­¾å­—ï¼š'),
                    new Paragraph({ text: ' ', spacing: { before: 200 } }),
                    new Paragraph('æ—¥æœŸï¼š'),
                  ],
                  width: { size: 50, type: WidthType.PERCENTAGE },
                }),
                new TableCell({
                  children: [
                    new Paragraph('ç­¾å­—ï¼š'),
                    new Paragraph({ text: ' ', spacing: { before: 200 } }),
                    new Paragraph('æ—¥æœŸï¼š'),
                  ],
                  width: { size: 50, type: WidthType.PERCENTAGE },
                }),
              ],
            }),
          ],
        })
      );

      const doc = new Document({
        sections: [{
          properties: {},
          children: children,
        }],
      });

      const blob = await Packer.toBlob(doc);
      const fileName = (data.contractTitle || 'åˆåŒ') + '_' + (data.contractNumber || new Date().toISOString().slice(0,10)) + '.docx';
      saveAs(blob, fileName);
      
      addMessage('ğŸ“„ åˆåŒWordæ–‡æ¡£å·²å¯¼å‡ºï¼š' + fileName, 'ai');
      alert('åˆåŒWordæ–‡æ¡£å·²æˆåŠŸå¯¼å‡ºï¼');
    });

    document.getElementById('contract-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const data = collectFormData();
      console.log('åˆåŒæ•°æ®ï¼š', data);
      
      addMessage('ğŸ‰ åˆåŒå·²ç”Ÿæˆï¼\n\nè¯·é¢„è§ˆç¡®è®¤æ— è¯¯åï¼Œå¯ä»¥å¯¼å‡ºWordæ–‡æ¡£ã€‚', 'ai');
      
      alert('åˆåŒä¿¡æ¯å·²æäº¤ï¼è¯·ç‚¹å‡»"ç”Ÿæˆé¢„è§ˆ"æˆ–"å¯¼å‡ºWord"æŸ¥çœ‹/å¯¼å‡ºåˆåŒã€‚');
    });

    document.getElementById('save-draft').addEventListener('click', function() {
      const data = collectFormData();
      localStorage.setItem('contractFormDraft', JSON.stringify(data));
      addMessage('âœ… åˆåŒè‰ç¨¿å·²ä¿å­˜åˆ°æœ¬åœ°', 'ai');
    });

    document.getElementById('reset-form').addEventListener('click', function() {
      if (confirm('ç¡®å®šè¦é‡ç½®åˆåŒå—ï¼Ÿå·²å¡«å†™çš„æ•°æ®å°†æ¸…ç©ºã€‚')) {
        document.getElementById('contract-form').reset();
        document.getElementById('party-b').value = 'æ­å·ä¿®èŒˆç§‘æŠ€æœ‰é™å…¬å¸';
        document.getElementById('party-b-contact').value = 'åˆ˜å…ˆç”Ÿ';
        document.querySelectorAll('.form-row').forEach(row => {
          row.classList.remove('filled', 'filling');
        });
        document.getElementById('preview-section').style.display = 'none';
        addMessage('åˆåŒå·²é‡ç½®ï¼Œæˆ‘ä»¬é‡æ–°å¼€å§‹å§ï¼ğŸ˜Š', 'ai');
        setTimeout(() => {
          initXiaoLi();
        }, 1000);
      }
    });

    function loadDraft() {
      const draft = localStorage.getItem('contractFormDraft');
      if (draft) {
        const data = JSON.parse(draft);
        
        if (data.contractTitle) document.getElementById('contract-title').value = data.contractTitle;
        if (data.contractNumber) document.getElementById('contract-number').value = data.contractNumber;
        if (data.signDate) document.getElementById('sign-date').value = data.signDate;
        if (data.partyA) document.getElementById('party-a').value = data.partyA;
        if (data.partyAContact) document.getElementById('party-a-contact').value = data.partyAContact;
        if (data.partyAPhone) document.getElementById('party-a-phone').value = data.partyAPhone;
        if (data.serviceContent) document.getElementById('service-content').value = data.serviceContent;
        if (data.videoCount) document.getElementById('video-count').value = data.videoCount;
        if (data.videoDuration) document.getElementById('video-duration').value = data.videoDuration;
        if (data.serviceStart) document.getElementById('service-start').value = data.serviceStart;
        if (data.serviceEnd) document.getElementById('service-end').value = data.serviceEnd;
        if (data.totalAmount) document.getElementById('total-amount').value = data.totalAmount;
        if (data.paymentDetail) document.getElementById('payment-detail').value = data.paymentDetail;
        if (data.deposit) document.getElementById('deposit').value = data.deposit;
        if (data.deliverables) document.getElementById('deliverables').value = data.deliverables;
        if (data.revisionTimes) document.getElementById('revision-times').value = data.revisionTimes;
        if (data.deliveryTime) document.getElementById('delivery-time').value = data.deliveryTime;
        if (data.disputeResolution) document.getElementById('dispute-resolution').value = data.disputeResolution;
        if (data.additionalTerms) document.getElementById('additional-terms').value = data.additionalTerms;
        
        if (data.paymentTerms) {
          const paymentRadio = document.querySelector(`input[name="payment-terms"][value="${data.paymentTerms}"]`);
          if (paymentRadio) paymentRadio.checked = true;
        }
        if (data.copyright) {
          const copyrightRadio = document.querySelector(`input[name="copyright"][value="${data.copyright}"]`);
          if (copyrightRadio) copyrightRadio.checked = true;
        }
        
        document.querySelectorAll('.form-row').forEach(row => {
          const fieldId = row.dataset.field;
          if (fieldId) {
            const field = document.getElementById(fieldId);
            if (field && field.value) {
              row.classList.add('filled');
            }
          }
        });
        
        addMessage('æ£€æµ‹åˆ°æ‚¨æœ‰æœªå®Œæˆçš„åˆåŒè‰ç¨¿ï¼Œå·²å¸®æ‚¨æ¢å¤ã€‚ç»§ç»­å®Œå–„åˆåŒå§ï¼ğŸ˜Š', 'ai');
        
        // æœ‰è‰ç¨¿ä¸”æœ‰AIé…ç½®æ—¶æ‰ç»§ç»­å¯¹è¯
        if (hasAIConfig()) {
          for (let i = 0; i < questions.length; i++) {
            const field = document.getElementById(questions[i].field);
            if (!field || !field.value) {
              currentQuestionIndex = i - 1;
              setTimeout(() => {
                askQuestion(i);
              }, 1500);
              return;
            }
          }
          setTimeout(() => {
            addMessage('çœ‹èµ·æ¥æ‚¨å·²ç»å¡«å†™å®Œæ‰€æœ‰ä¿¡æ¯äº†ï¼è¯·æ£€æŸ¥ä¸€ä¸‹å·¦ä¾§è¡¨å•ï¼Œç¡®è®¤æ— è¯¯åå°±å¯ä»¥æäº¤å•¦~ ğŸ‰', 'ai');
          }, 1500);
        }
      } else {
        // æ— è‰ç¨¿æ—¶ï¼Œæ ¹æ®æ˜¯å¦æœ‰AIé…ç½®å†³å®šæ˜¯å¦è‡ªåŠ¨å¼€å§‹å¯¹è¯
        if (hasAIConfig()) {
          initXiaoLi();
        } else {
          addMessage('ğŸ¤– æ‚¨å¥½ï¼æˆ‘æ˜¯å°æï¼Œä¿®èŒˆç§‘æŠ€çš„åˆåŒä¸“å‘˜ã€‚\n\nè¯·å…ˆåœ¨ç»„ç»‡æ¶æ„ä¸­ä¸ºæ­¤ä»»åŠ¡æ¥å…¥AIæ¨¡å‹ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹æ‹Ÿå®šåˆåŒå•¦ï¼', 'ai');
        }
      }
    }

    window.addEventListener('load', function() {
      displayAIModelInfo();
      loadDraft();
    });

    // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„ AI é…ç½®ï¼ˆåªéœ€è¦æœ‰æ¨¡å‹å³å¯ï¼ŒapiKeyå¯èƒ½åœ¨å…¨å±€é…ç½®ä¸­ï¼‰
    function hasAIConfig() {
      const config = getAIConfig();
      return config.provider && config.model;
    }
  </script>
</body>
</html>
