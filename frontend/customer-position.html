<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>è´¦å·å®šä½&æœåŠ¡å‘¨æœŸç¡®è®¤ - å®¢æˆ·æ•°æ®ä¸­å¿ƒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“Š</text></svg>" />
  <link rel="stylesheet" href="./style.css" />
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #1a1f2e 0%, #0d1117 100%);
      color: #e6edf3;
      min-height: 100vh;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
    }

    /* å¤´éƒ¨ */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 2px solid #30363d;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-title h1 {
      font-size: 24px;
      color: #58a6ff;
    }

    .header-title p {
      color: #8b949e;
      font-size: 14px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: rgba(22, 27, 34, 0.8);
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .stat-icon.blue { background: rgba(88, 166, 255, 0.2); color: #58a6ff; }
    .stat-icon.green { background: rgba(35, 197, 94, 0.2); color: #23c55e; }
    .stat-icon.orange { background: rgba(240, 136, 62, 0.2); color: #f0883e; }
    .stat-icon.purple { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }

    .stat-info h3 {
      font-size: 14px;
      color: #8b949e;
      margin-bottom: 4px;
    }

    .stat-info .number {
      font-size: 28px;
      font-weight: 700;
      color: #e6edf3;
    }

    /* ç­›é€‰æ  */
    .filter-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-box {
      position: relative;
      flex: 1;
      min-width: 250px;
      max-width: 400px;
    }

    .search-box input {
      width: 100%;
      padding: 10px 16px 10px 40px;
      background: rgba(22, 27, 34, 0.8);
      border: 1px solid #30363d;
      border-radius: 8px;
      color: #e6edf3;
      font-size: 14px;
    }

    .search-box input:focus {
      outline: none;
      border-color: #58a6ff;
    }

    .search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #8b949e;
    }

    .filter-select {
      padding: 10px 16px;
      background: rgba(22, 27, 34, 0.8);
      border: 1px solid #30363d;
      border-radius: 8px;
      color: #e6edf3;
      font-size: 14px;
      cursor: pointer;
    }

    .filter-select:focus {
      outline: none;
      border-color: #58a6ff;
    }

    /* æŒ‰é’® */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #58a6ff 0%, #1f6feb 100%);
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #79b8ff 0%, #388bfd 100%);
    }

    .btn-secondary {
      background: rgba(48, 54, 61, 0.8);
      color: #e6edf3;
      border: 1px solid #30363d;
    }

    .btn-secondary:hover {
      background: rgba(48, 54, 61, 1);
    }

    .btn-danger {
      background: rgba(248, 81, 73, 0.2);
      color: #f85149;
      border: 1px solid rgba(248, 81, 73, 0.3);
    }

    .btn-danger:hover {
      background: rgba(248, 81, 73, 0.3);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    /* å®¢æˆ·åˆ—è¡¨ */
    .customer-list {
      background: rgba(22, 27, 34, 0.6);
      border: 1px solid #30363d;
      border-radius: 12px;
      overflow: hidden;
    }

    .list-header {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr 120px;
      gap: 16px;
      padding: 16px 20px;
      background: rgba(13, 17, 23, 0.8);
      border-bottom: 1px solid #30363d;
      font-weight: 600;
      color: #8b949e;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .customer-item {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr 120px;
      gap: 16px;
      padding: 16px 20px;
      border-bottom: 1px solid #30363d;
      align-items: center;
      transition: background 0.2s;
      cursor: pointer;
    }

    .customer-item:hover {
      background: rgba(48, 54, 61, 0.3);
    }

    .customer-item:last-child {
      border-bottom: none;
    }

    .customer-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .customer-name {
      font-weight: 600;
      color: #e6edf3;
      font-size: 15px;
    }

    .customer-meta {
      color: #8b949e;
      font-size: 12px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-pending {
      background: rgba(240, 136, 62, 0.2);
      color: #f0883e;
    }

    .status-confirmed {
      background: rgba(88, 166, 255, 0.2);
      color: #58a6ff;
    }

    .status-in_progress {
      background: rgba(139, 92, 246, 0.2);
      color: #8b5cf6;
    }

    .status-completed {
      background: rgba(35, 197, 94, 0.2);
      color: #23c55e;
    }

    .customer-actions {
      display: flex;
      gap: 8px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #8b949e;
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* æ¨¡æ€æ¡† */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transform: scale(0.9);
      transition: transform 0.3s;
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #30363d;
    }

    .modal-header h2 {
      font-size: 18px;
      color: #e6edf3;
    }

    .modal-close {
      background: none;
      border: none;
      color: #8b949e;
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
    }

    .modal-close:hover {
      color: #e6edf3;
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px;
      border-top: 1px solid #30363d;
    }

    /* è¡¨å•æ ·å¼ */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-label {
      font-size: 14px;
      color: #c9d1d9;
      font-weight: 500;
    }

    .form-input,
    .form-select,
    .form-textarea {
      padding: 10px 14px;
      background: rgba(13, 17, 23, 0.8);
      border: 1px solid #30363d;
      border-radius: 8px;
      color: #e6edf3;
      font-size: 14px;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #58a6ff;
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .info-section {
      margin-bottom: 24px;
    }

    .info-section h3 {
      font-size: 14px;
      color: #f0883e;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #30363d;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .info-label {
      font-size: 12px;
      color: #8b949e;
    }

    .info-value {
      font-size: 14px;
      color: #e6edf3;
    }

    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tag {
      padding: 4px 10px;
      background: rgba(88, 166, 255, 0.15);
      border: 1px solid rgba(88, 166, 255, 0.3);
      border-radius: 4px;
      font-size: 12px;
      color: #58a6ff;
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading {
      text-align: center;
      padding: 40px;
      color: #8b949e;
    }

    .loading i {
      font-size: 32px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* å“åº”å¼ */
    @media (max-width: 1024px) {
      .list-header,
      .customer-item {
        grid-template-columns: 2fr 1fr 1fr 100px;
      }

      .list-header > :nth-child(3),
      .customer-item > :nth-child(4) {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .list-header,
      .customer-item {
        grid-template-columns: 2fr 1fr 100px;
      }

      .list-header > :nth-child(2),
      .customer-item > :nth-child(3) {
        display: none;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨ -->
    <div class="header">
      <div class="header-title">
        <i class="ph ph-users" style="font-size: 32px; color: #58a6ff;"></i>
        <div>
          <h1>è´¦å·å®šä½&æœåŠ¡å‘¨æœŸç¡®è®¤</h1>
          <p>å®¢æˆ·æ•°æ®ä¸­å¿ƒ - ç®¡ç†æ‰€æœ‰å®¢æˆ·éœ€æ±‚å’Œè´¦å·å®šä½ä¿¡æ¯</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="window.location.href='index.html'">
          <i class="ph ph-arrow-left"></i>
          è¿”å›ç³»ç»Ÿ
        </button>
        <button class="btn btn-primary" onclick="openAddModal()">
          <i class="ph ph-plus"></i>
          æ–°å¢å®¢æˆ·
        </button>
      </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon blue">
          <i class="ph ph-users"></i>
        </div>
        <div class="stat-info">
          <h3>æ€»å®¢æˆ·æ•°</h3>
          <div class="number" id="stat-total">0</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon orange">
          <i class="ph ph-clock"></i>
        </div>
        <div class="stat-info">
          <h3>å¾…ç¡®è®¤</h3>
          <div class="number" id="stat-pending">0</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon purple">
          <i class="ph ph-spinner"></i>
        </div>
        <div class="stat-info">
          <h3>æœåŠ¡ä¸­</h3>
          <div class="number" id="stat-inprogress">0</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green">
          <i class="ph ph-check-circle"></i>
        </div>
        <div class="stat-info">
          <h3>å·²å®Œæˆ</h3>
          <div class="number" id="stat-completed">0</div>
        </div>
      </div>
    </div>

    <!-- ç­›é€‰æ  -->
    <div class="filter-bar">
      <div class="search-box">
        <i class="ph ph-magnifying-glass"></i>
        <input type="text" id="searchInput" placeholder="æœç´¢å“ç‰Œåã€è¡Œä¸šã€è”ç³»äºº..." oninput="handleSearch()">
      </div>
      <select class="filter-select" id="industryFilter" onchange="handleFilter()">
        <option value="">æ‰€æœ‰è¡Œä¸š</option>
        <option value="é¤é¥®">é¤é¥®</option>
        <option value="é›¶å”®">é›¶å”®</option>
        <option value="æ•™è‚²">æ•™è‚²</option>
        <option value="åŒ»ç–—">åŒ»ç–—</option>
        <option value="ç§‘æŠ€">ç§‘æŠ€</option>
        <option value="å¨±ä¹">å¨±ä¹</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
      </select>
      <select class="filter-select" id="statusFilter" onchange="handleFilter()">
        <option value="">æ‰€æœ‰çŠ¶æ€</option>
        <option value="pending">å¾…ç¡®è®¤</option>
        <option value="confirmed">å·²ç¡®è®¤</option>
        <option value="in_progress">æœåŠ¡ä¸­</option>
        <option value="completed">å·²å®Œæˆ</option>
      </select>
      <button class="btn btn-secondary" onclick="loadCustomers()">
        <i class="ph ph-arrows-clockwise"></i>
        åˆ·æ–°
      </button>
    </div>

    <!-- å®¢æˆ·åˆ—è¡¨ -->
    <div class="customer-list">
      <div class="list-header">
        <div>å®¢æˆ·ä¿¡æ¯</div>
        <div>è¡Œä¸š</div>
        <div>æœåŠ¡å‘¨æœŸ</div>
        <div>åˆ›å»ºæ—¶é—´</div>
        <div>çŠ¶æ€</div>
        <div>æ“ä½œ</div>
      </div>
      <div id="customerListBody">
        <div class="loading">
          <i class="ph ph-spinner"></i>
          <p>åŠ è½½ä¸­...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- å®¢æˆ·è¯¦æƒ…/ç¼–è¾‘æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="customerModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">å®¢æˆ·è¯¦æƒ…</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- åŠ¨æ€å†…å®¹ -->
      </div>
      <div class="modal-footer" id="modalFooter">
        <!-- åŠ¨æ€æŒ‰é’® -->
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€çŠ¶æ€
    let customers = [];
    let currentCustomer = null;
    let isEditMode = false;

    // çŠ¶æ€æ˜ å°„
    const statusMap = {
      pending: { label: 'å¾…ç¡®è®¤', class: 'status-pending' },
      confirmed: { label: 'å·²ç¡®è®¤', class: 'status-confirmed' },
      in_progress: { label: 'æœåŠ¡ä¸­', class: 'status-in_progress' },
      completed: { label: 'å·²å®Œæˆ', class: 'status-completed' }
    };

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadCustomers();
    });

    // åŠ è½½å®¢æˆ·åˆ—è¡¨
    async function loadCustomers() {
      try {
        const response = await fetch('/api/customers');
        const result = await response.json();
        if (!response.ok || result.success === false) {
          const msg = result && result.error && result.error.message ? result.error.message : 'åŠ è½½å¤±è´¥';
          throw new Error(msg);
        }
        customers = Array.isArray(result.data) ? result.data : [];
        renderCustomerList(customers);
        updateStats();
      } catch (error) {
        console.error('åŠ è½½å®¢æˆ·åˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('customerListBody').innerHTML = `
          <div class="empty-state">
            <i class="ph ph-warning-circle"></i>
            <p>åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
          </div>
        `;
      }
    }

    // æ¸²æŸ“å®¢æˆ·åˆ—è¡¨
    function renderCustomerList(data) {
      const container = document.getElementById('customerListBody');
      
      if (data.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="ph ph-users"></i>
            <p>æš‚æ— å®¢æˆ·æ•°æ®</p>
          </div>
        `;
        return;
      }

      container.innerHTML = data.map(customer => {
        const status = statusMap[customer.status] || statusMap.pending;
        return `
          <div class="customer-item" onclick="viewCustomer(${customer.id})">
            <div class="customer-info">
              <div class="customer-name">${customer.brandName || 'æœªå‘½å'}</div>
              <div class="customer-meta">${customer.contactName || 'æš‚æ— è”ç³»äºº'} ${customer.contactPhone || ''}</div>
            </div>
            <div>${customer.industry || '-'}</div>
            <div>${customer.term || '-'}</div>
            <div>${formatDate(customer.createdAt)}</div>
            <div>
              <span class="status-badge ${status.class}">
                <i class="ph ph-circle" style="font-size: 8px;"></i>
                ${status.label}
              </span>
            </div>
            <div class="customer-actions" onclick="event.stopPropagation()">
              <button class="btn btn-sm btn-secondary" onclick="editCustomer(${customer.id})">
                <i class="ph ph-pencil"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${customer.id})">
                <i class="ph ph-trash"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // æ›´æ–°ç»Ÿè®¡
    function updateStats() {
      document.getElementById('stat-total').textContent = customers.length;
      document.getElementById('stat-pending').textContent = customers.filter(c => c.status === 'pending').length;
      document.getElementById('stat-inprogress').textContent = customers.filter(c => c.status === 'in_progress').length;
      document.getElementById('stat-completed').textContent = customers.filter(c => c.status === 'completed').length;
    }

    // æœç´¢åŠŸèƒ½
    function handleSearch() {
      const term = document.getElementById('searchInput').value.toLowerCase();
      const filtered = customers.filter(c => 
        (c.brandName && c.brandName.toLowerCase().includes(term)) ||
        (c.industry && c.industry.toLowerCase().includes(term)) ||
        (c.contactName && c.contactName.toLowerCase().includes(term)) ||
        (c.contactPhone && c.contactPhone.includes(term))
      );
      renderCustomerList(filtered);
    }

    // ç­›é€‰åŠŸèƒ½
    function handleFilter() {
      const industry = document.getElementById('industryFilter').value;
      const status = document.getElementById('statusFilter').value;
      
      let filtered = customers;
      
      if (industry) {
        filtered = filtered.filter(c => c.industry === industry);
      }
      
      if (status) {
        filtered = filtered.filter(c => c.status === status);
      }
      
      renderCustomerList(filtered);
    }

    // æŸ¥çœ‹å®¢æˆ·è¯¦æƒ…
    async function viewCustomer(id) {
      try {
        const response = await fetch(`/api/customers/${id}`);
        const result = await response.json();
        if (!response.ok || result.success === false) {
          const msg = result && result.error && result.error.message ? result.error.message : 'åŠ è½½å®¢æˆ·è¯¦æƒ…å¤±è´¥';
          throw new Error(msg);
        }
        currentCustomer = result.data || null;
        isEditMode = false;
        renderCustomerDetail();
        openModal();
      } catch (error) {
        console.error('åŠ è½½å®¢æˆ·è¯¦æƒ…å¤±è´¥:', error);
        alert('åŠ è½½å®¢æˆ·è¯¦æƒ…å¤±è´¥');
      }
    }

    // æ¸²æŸ“å®¢æˆ·è¯¦æƒ…
    function renderCustomerDetail() {
      const c = currentCustomer;
      document.getElementById('modalTitle').textContent = 'å®¢æˆ·è¯¦æƒ…';
      
      document.getElementById('modalBody').innerHTML = `
        <div class="info-section">
          <h3>åŸºæœ¬ä¿¡æ¯</h3>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">å“ç‰Œåç§°</div>
              <div class="info-value">${c.brandName || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">è¡Œä¸š</div>
              <div class="info-value">${c.industry || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">åœ°å€</div>
              <div class="info-value">${c.address || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">è´¦å·ä¿¡æ¯</div>
              <div class="info-value">${c.accountInfo || '-'}</div>
            </div>
          </div>
        </div>

        <div class="info-section">
          <h3>è”ç³»ä¿¡æ¯</h3>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">è”ç³»äºº</div>
              <div class="info-value">${c.contactName || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">è”ç³»ç”µè¯</div>
              <div class="info-value">${c.contactPhone || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">å¾®ä¿¡å·</div>
              <div class="info-value">${c.contactWechat || '-'}</div>
            </div>
          </div>
        </div>

        <div class="info-section">
          <h3>è§†é¢‘éœ€æ±‚</h3>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">è§†é¢‘ç”¨é€”</div>
              <div class="tag-list">
                ${(c.videoPurpose || []).map(p => `<span class="tag">${p}</span>`).join('') || '<span class="info-value">-</span>'}
              </div>
            </div>
            <div class="info-item">
              <div class="info-label">é¢„æœŸæ—¶é•¿</div>
              <div class="info-value">${c.duration || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">åˆ›æ–°åº¦</div>
              <div class="info-value">${c.innovation || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">é¢„ç®—</div>
              <div class="info-value">${c.budget || '-'}</div>
            </div>
          </div>
        </div>

        <div class="info-section">
          <h3>è´¦å·å®šä½</h3>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">è´¦å·å®šä½</div>
              <div class="info-value">${c.accountPosition || 'å¾…è¡¥å……'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">å†…å®¹é£æ ¼</div>
              <div class="info-value">${c.contentStyle || 'å¾…è¡¥å……'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">æœåŠ¡å‘¨æœŸ</div>
              <div class="info-value">${c.serviceCycle || c.term || 'å¾…è¡¥å……'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">é˜¶æ®µç›®æ ‡</div>
              <div class="info-value">${c.goals || 'å¾…è¡¥å……'}</div>
            </div>
          </div>
        </div>

        <div class="info-section">
          <h3>å…¶ä»–ä¿¡æ¯</h3>
          <div class="info-grid">
            <div class="info-item full-width">
              <div class="info-label">ç”¨æˆ·éœ€æ±‚</div>
              <div class="info-value">${c.userRequirements || '-'}</div>
            </div>
            <div class="info-item full-width">
              <div class="info-label">ç‰¹è‰²äº®ç‚¹</div>
              <div class="info-value">${c.highlights || '-'}</div>
            </div>
            <div class="info-item full-width">
              <div class="info-label">å¤‡æ³¨</div>
              <div class="info-value">${c.other || '-'}</div>
            </div>
          </div>
        </div>
      `;

      const status = statusMap[c.status] || statusMap.pending;
      document.getElementById('modalFooter').innerHTML = `
        <span class="status-badge ${status.class}" style="margin-right: auto;">
          ${status.label}
        </span>
        <button class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
        <button class="btn btn-primary" onclick="enableEditMode()">ç¼–è¾‘</button>
      `;
    }

    // å¯ç”¨ç¼–è¾‘æ¨¡å¼
    function enableEditMode() {
      isEditMode = true;
      renderEditForm();
    }

    // æ¸²æŸ“ç¼–è¾‘è¡¨å•
    function renderEditForm() {
      const c = currentCustomer;
      document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å®¢æˆ·ä¿¡æ¯';
      
      document.getElementById('modalBody').innerHTML = `
        <div class="info-section">
          <h3>è´¦å·å®šä½ä¿¡æ¯</h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">è´¦å·å®šä½</label>
              <input type="text" class="form-input" id="edit-accountPosition" value="${c.accountPosition || ''}" placeholder="ä¾‹å¦‚ï¼šç¾é£Ÿæ¢åº—è¾¾äºº">
            </div>
            <div class="form-group">
              <label class="form-label">å†…å®¹é£æ ¼</label>
              <input type="text" class="form-input" id="edit-contentStyle" value="${c.contentStyle || ''}" placeholder="ä¾‹å¦‚ï¼šè½»æ¾å¹½é»˜ã€ä¸“ä¸šä¸¥è°¨">
            </div>
            <div class="form-group">
              <label class="form-label">æœåŠ¡å‘¨æœŸ</label>
              <input type="text" class="form-input" id="edit-serviceCycle" value="${c.serviceCycle || ''}" placeholder="ä¾‹å¦‚ï¼š3ä¸ªæœˆ">
            </div>
            <div class="form-group">
              <label class="form-label">çŠ¶æ€</label>
              <select class="form-select" id="edit-status">
                <option value="pending" ${c.status === 'pending' ? 'selected' : ''}>å¾…ç¡®è®¤</option>
                <option value="confirmed" ${c.status === 'confirmed' ? 'selected' : ''}>å·²ç¡®è®¤</option>
                <option value="in_progress" ${c.status === 'in_progress' ? 'selected' : ''}>æœåŠ¡ä¸­</option>
                <option value="completed" ${c.status === 'completed' ? 'selected' : ''}>å·²å®Œæˆ</option>
              </select>
            </div>
            <div class="form-group full-width">
              <label class="form-label">é˜¶æ®µç›®æ ‡</label>
              <textarea class="form-textarea" id="edit-goals" placeholder="æè¿°é˜¶æ®µæ€§è¿è¥ç›®æ ‡">${c.goals || ''}</textarea>
            </div>
          </div>
        </div>

        <div class="info-section">
          <h3>åŸºæœ¬ä¿¡æ¯</h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">å“ç‰Œåç§°</label>
              <input type="text" class="form-input" id="edit-brandName" value="${c.brandName || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">è¡Œä¸š</label>
              <input type="text" class="form-input" id="edit-industry" value="${c.industry || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">è”ç³»äºº</label>
              <input type="text" class="form-input" id="edit-contactName" value="${c.contactName || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">è”ç³»ç”µè¯</label>
              <input type="text" class="form-input" id="edit-contactPhone" value="${c.contactPhone || ''}">
            </div>
          </div>
        </div>
      `;

      document.getElementById('modalFooter').innerHTML = `
        <button class="btn btn-secondary" onclick="renderCustomerDetail()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveCustomer()">ä¿å­˜</button>
      `;
    }

    // ä¿å­˜å®¢æˆ·
    async function saveCustomer() {
      const data = {
        accountPosition: document.getElementById('edit-accountPosition').value,
        contentStyle: document.getElementById('edit-contentStyle').value,
        serviceCycle: document.getElementById('edit-serviceCycle').value,
        goals: document.getElementById('edit-goals').value,
        status: document.getElementById('edit-status').value,
        brandName: document.getElementById('edit-brandName').value,
        industry: document.getElementById('edit-industry').value,
        contactName: document.getElementById('edit-contactName').value,
        contactPhone: document.getElementById('edit-contactPhone').value
      };

      try {
        const response = await fetch(`/api/customers/${currentCustomer.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        if (response.ok && result && result.success !== false) {
          currentCustomer = result.data || null;
          loadCustomers();
          renderCustomerDetail();
          alert('ä¿å­˜æˆåŠŸï¼');
        } else {
          const msg = result && result.error && result.error.message ? result.error.message : 'ä¿å­˜å¤±è´¥';
          throw new Error(msg);
        }
      } catch (error) {
        console.error('ä¿å­˜å®¢æˆ·å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // ç¼–è¾‘å®¢æˆ·
    async function editCustomer(id) {
      await viewCustomer(id);
      enableEditMode();
    }

    // åˆ é™¤å®¢æˆ·
    async function deleteCustomer(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®¢æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        return;
      }

      try {
        const response = await fetch(`/api/customers/${id}`, {
          method: 'DELETE'
        });

        const result = await response.json();
        if (response.ok && result && result.success !== false) {
          loadCustomers();
          alert('åˆ é™¤æˆåŠŸï¼');
        } else {
          const msg = result && result.error && result.error.message ? result.error.message : 'åˆ é™¤å¤±è´¥';
          throw new Error(msg);
        }
      } catch (error) {
        console.error('åˆ é™¤å®¢æˆ·å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // æ‰“å¼€æ–°å¢æ¨¡æ€æ¡†
    function openAddModal() {
      currentCustomer = null;
      isEditMode = true;
      document.getElementById('modalTitle').textContent = 'æ–°å¢å®¢æˆ·';
      
      document.getElementById('modalBody').innerHTML = `
        <div class="info-section">
          <h3>åŸºæœ¬ä¿¡æ¯ï¼ˆå¿…å¡«ï¼‰</h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">å“ç‰Œåç§° *</label>
              <input type="text" class="form-input" id="new-brandName" placeholder="è¾“å…¥å“ç‰Œåç§°">
            </div>
            <div class="form-group">
              <label class="form-label">è¡Œä¸š</label>
              <select class="form-select" id="new-industry">
                <option value="">è¯·é€‰æ‹©</option>
                <option value="é¤é¥®">é¤é¥®</option>
                <option value="é›¶å”®">é›¶å”®</option>
                <option value="æ•™è‚²">æ•™è‚²</option>
                <option value="åŒ»ç–—">åŒ»ç–—</option>
                <option value="ç§‘æŠ€">ç§‘æŠ€</option>
                <option value="å¨±ä¹">å¨±ä¹</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">è”ç³»äºº</label>
              <input type="text" class="form-input" id="new-contactName" placeholder="è¾“å…¥è”ç³»äººå§“å">
            </div>
            <div class="form-group">
              <label class="form-label">è”ç³»ç”µè¯</label>
              <input type="text" class="form-input" id="new-contactPhone" placeholder="è¾“å…¥è”ç³»ç”µè¯">
            </div>
            <div class="form-group">
              <label class="form-label">å¾®ä¿¡å·</label>
              <input type="text" class="form-input" id="new-contactWechat" placeholder="è¾“å…¥å¾®ä¿¡å·">
            </div>
            <div class="form-group">
              <label class="form-label">æœåŠ¡å‘¨æœŸ</label>
              <select class="form-select" id="new-term">
                <option value="">è¯·é€‰æ‹©</option>
                <option value="1ä¸ªæœˆ">1ä¸ªæœˆ</option>
                <option value="3ä¸ªæœˆ">3ä¸ªæœˆ</option>
                <option value="6ä¸ªæœˆ">6ä¸ªæœˆ</option>
                <option value="1å¹´">1å¹´</option>
                <option value="é•¿æœŸåˆä½œ">é•¿æœŸåˆä½œ</option>
              </select>
            </div>
          </div>
        </div>
      `;

      document.getElementById('modalFooter').innerHTML = `
        <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="createCustomer()">åˆ›å»º</button>
      `;

      openModal();
    }

    // åˆ›å»ºå®¢æˆ·
    async function createCustomer() {
      const brandName = document.getElementById('new-brandName').value;
      if (!brandName) {
        alert('å“ç‰Œåç§°ä¸èƒ½ä¸ºç©º');
        return;
      }

      const data = {
        brandName: brandName,
        industry: document.getElementById('new-industry').value,
        contactName: document.getElementById('new-contactName').value,
        contactPhone: document.getElementById('new-contactPhone').value,
        contactWechat: document.getElementById('new-contactWechat').value,
        term: document.getElementById('new-term').value,
        status: 'pending'
      };

      try {
        const response = await fetch('/api/customers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        if (response.ok && result && result.success !== false) {
          closeModal();
          loadCustomers();
          alert('å®¢æˆ·åˆ›å»ºæˆåŠŸï¼');
        } else {
          const msg = result && result.error && result.error.message ? result.error.message : 'åˆ›å»ºå¤±è´¥';
          throw new Error(msg);
        }
      } catch (error) {
        console.error('åˆ›å»ºå®¢æˆ·å¤±è´¥:', error);
        alert('åˆ›å»ºå¤±è´¥: ' + error.message);
      }
    }

    // æ¨¡æ€æ¡†æ§åˆ¶
    function openModal() {
      document.getElementById('customerModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('customerModal').classList.remove('active');
      document.body.style.overflow = '';
      currentCustomer = null;
      isEditMode = false;
    }

    // ç‚¹å‡»é®ç½©å…³é—­
    document.getElementById('customerModal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        closeModal();
      }
    });

    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN');
    }
  </script>
</body>
</html>
