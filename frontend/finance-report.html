<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>è´¢åŠ¡éƒ¨å·¥ä½œå° - æ¨¡å‹èŠ±è´¹å­é¡¹ç›®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./style.css" />
  <link rel="stylesheet" href="./disc-assistant.css" />
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top left, #101827 0, #020617 45%, #000 100%);
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-primary);
    }
    .finance-container {
      max-width: 1240px;
      margin: 0 auto;
      padding: 32px 20px 40px;
      box-sizing: border-box;
    }
    .finance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 18px 22px;
      border-radius: 16px;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.18), transparent 55%),
                  radial-gradient(circle at top right, rgba(94, 234, 212, 0.16), transparent 55%),
                  rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.8);
    }
    .filters-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
      align-items: center;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 160px;
    }
    .filter-group label {
      font-size: 12px;
      color: var(--text-muted);
    }
    .filter-group select {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 13px;
    }
    .finance-header h1 {
      margin: 0;
      font-size: 22px;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .finance-header-subtitle {
      margin-top: 4px;
      font-size: 13px;
      color: #9ca3af;
    }
    .project-tabs {
      display: inline-flex;
      gap: 8px;
      margin-top: 10px;
    }
    .project-tab {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.8);
      color: #9ca3af;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .project-tab.active {
      background: rgba(34, 197, 94, 0.18);
      border-color: rgba(34, 197, 94, 0.8);
      color: #bbf7d0;
    }
    .project-tab.badge {
      border-style: dashed;
      opacity: 0.7;
    }
    .finance-header .actions {
      display: flex;
      gap: 12px;
    }
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .summary-card {
      position: relative;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.16), transparent 60%),
                  rgba(15, 23, 42, 0.9);
      border-radius: 14px;
      padding: 18px 18px 16px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      overflow: hidden;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.7);
    }
    .summary-card .value {
      font-size: 26px;
      font-weight: bold;
      color: #38bdf8;
      margin-bottom: 6px;
    }
    .summary-card .label {
      font-size: 14px;
      color: #9ca3af;
    }
    .summary-card .badge {
      position: absolute;
      top: 10px;
      right: 14px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .section-title {
      font-size: 18px;
      font-weight: bold;
      margin: 26px 0 14px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(31, 41, 55, 0.9);
    }
    th, td {
      padding: 11px 14px;
      text-align: left;
      border-bottom: 1px solid rgba(31, 41, 55, 0.85);
    }
    th {
      background: rgba(15, 23, 42, 0.98);
      font-weight: 600;
      font-size: 13px;
      color: #9ca3af;
    }
    td {
      color: #d1d5db;
      font-size: 13px;
    }
    tr:hover td {
      background: rgba(31, 41, 55, 0.9);
    }
    .loading {
      text-align: center;
      padding: 32px;
      color: #9ca3af;
    }
    .empty {
      text-align: center;
      padding: 32px;
      color: #6b7280;
    }
    .trend-chart {
      height: 180px;
      display: flex;
      align-items: flex-end;
      gap: 6px;
      padding: 12px 10px 6px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 12px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      overflow-x: auto;
      box-sizing: border-box;
    }
    .trend-bar {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      min-width: 26px;
      gap: 4px;
    }
    .trend-bar-inner {
      width: 100%;
      border-radius: 6px 6px 2px 2px;
      background: linear-gradient(to top, #22c55e, #4ade80);
    }
    .trend-bar-label {
      font-size: 10px;
      color: #9ca3af;
    }
    .topn-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    .topn-card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 12px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 12px 14px;
    }
    .topn-card-title {
      font-size: 13px;
      font-weight: 600;
      color: #e5e7eb;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .topn-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .topn-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      font-size: 13px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.7);
    }
    .topn-item:last-child {
      border-bottom: none;
    }
    .topn-item-label {
      color: #d1d5db;
    }
    .topn-item-value {
      color: #38bdf8;
      font-weight: 500;
    }
    .budget-table-note {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 6px;
    }
    .budget-over {
      color: #fecaca;
    }
    .budget-under {
      color: #bbf7d0;
    }
    .budget-near {
      color: #fde68a;
    }
    .insight-box {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 12px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 12px 14px;
      font-size: 13px;
      color: #d1d5db;
    }
    .insight-box ul {
      padding-left: 18px;
      margin: 6px 0 0;
    }
    .insight-box li {
      margin-bottom: 4px;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #22c55e;
      color: #022c22;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }
    .btn-primary:hover {
      background: #16a34a;
    }
    .btn-secondary {
      background: rgba(15, 23, 42, 0.7);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.5);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-secondary:hover {
      background: rgba(31, 41, 55, 0.9);
    }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #9ca3af;
      text-decoration: none;
      margin-bottom: 16px;
      font-size: 13px;
    }
    .back-link:hover {
      color: #e5e7eb;
    }
  </style>
</head>
<body>
  <div class="finance-container">
    <a href="./index.html" class="back-link">
      <i class="ph ph-arrow-left"></i> è¿”å›å…¬å¸å·¥ä½œå°
    </a>
    
    <div class="finance-header">
      <div>
        <h1>ğŸ’° è´¢åŠ¡éƒ¨å·¥ä½œå°</h1>
        <div class="finance-header-subtitle">
          é¢å‘è´¢åŠ¡éƒ¨çš„å·¥ä½œçœ‹æ¿ï¼Œå½“å‰å±•ç¤ºçš„æ˜¯ã€ŒAI èŠ±è´¹ã€å­é¡¹ç›®ï¼šæ€»è§ˆè°ƒç”¨é‡ã€è´¹ç”¨ï¼Œå¹¶æŒ‰éƒ¨é—¨ / å‘˜å·¥ / é¡¹ç›®æ‹†åˆ†ã€‚
        </div>
        <div class="project-tabs">
          <div class="project-tab active">
            <i class="ph ph-sparkle"></i><span>AI èŠ±è´¹æŠ¥è¡¨</span>
          </div>
          <div class="project-tab badge">
            <i class="ph ph-dots-three-outline"></i><span>æ›´å¤šè´¢åŠ¡å­é¡¹ç›®ï¼ˆé¢„ç•™ï¼‰</span>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-secondary" onclick="loadData()">
          <i class="ph ph-arrow-clockwise"></i> åˆ·æ–°æ•°æ®
        </button>
        <button class="btn btn-primary" onclick="exportDoc()">
          <i class="ph ph-file-text"></i> å¯¼å‡º Word æŠ¥è¡¨
        </button>
      </div>
    </div>

    <div id="summary-cards" class="summary-cards">
      <div class="summary-card">
        <span class="badge"><i class="ph ph-activity"></i>è°ƒç”¨</span>
        <div class="value" id="total-calls">-</div>
        <div class="label">æ€»è°ƒç”¨æ¬¡æ•°</div>
      </div>
      <div class="summary-card">
        <span class="badge"><i class="ph ph-coins"></i>ç”¨é‡</span>
        <div class="value" id="total-tokens">-</div>
        <div class="label">æ€» Tokens</div>
      </div>
      <div class="summary-card">
        <span class="badge"><i class="ph ph-currency-circle-dollar"></i>æˆæœ¬</span>
        <div class="value" id="total-cost">-</div>
        <div class="label">æ€»é¢„è®¡è´¹ç”¨(å…ƒ)</div>
      </div>
    </div>

    <div class="filters-bar">
      <div class="filter-group">
        <label for="date-range">æ—¶é—´èŒƒå›´</label>
        <select id="date-range">
          <option value="all">å…¨éƒ¨</option>
          <option value="7">è¿‘ 7 å¤©</option>
          <option value="30">è¿‘ 30 å¤©</option>
          <option value="90">è¿‘ 90 å¤©</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="provider-filter">æä¾›å•†</label>
        <select id="provider-filter">
          <option value="">å…¨éƒ¨</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="source-type-filter">æ¥æºç±»å‹</label>
        <select id="source-type-filter">
          <option value="">å…¨éƒ¨</option>
          <option value="department">éƒ¨é—¨</option>
          <option value="employee">å‘˜å·¥</option>
          <option value="project">é¡¹ç›®</option>
          <option value="assistant">å°ç¢ŸåŠ©æ‰‹</option>
          <option value="global-assistant">é¡¶éƒ¨ AI åŠ©æ‰‹</option>
        </select>
      </div>
    </div>

    <h2 class="section-title"><i class="ph ph-chart-line-up"></i> è´¹ç”¨è¶‹åŠ¿ï¼ˆæŒ‰æ—¥ï¼‰</h2>
    <div id="trend-chart" class="trend-chart">
      <div class="loading">åŠ è½½ä¸­...</div>
    </div>

    <h2 class="section-title"><i class="ph ph-trophy"></i> TopN æ’è¡Œ</h2>
    <div class="topn-grid">
      <div class="topn-card">
        <div class="topn-card-title">
          <i class="ph ph-cpu"></i>æ¨¡å‹è´¹ç”¨ Top 5
        </div>
        <ul id="topn-models" class="topn-list">
          <li class="loading">åŠ è½½ä¸­...</li>
        </ul>
      </div>
      <div class="topn-card">
        <div class="topn-card-title">
          <i class="ph ph-users-three"></i>æ¥æºè´¹ç”¨ Top 5
        </div>
        <ul id="topn-sources" class="topn-list">
          <li class="loading">åŠ è½½ä¸­...</li>
        </ul>
      </div>
    </div>

    <h2 class="section-title"><i class="ph ph-wallet"></i> éƒ¨é—¨é¢„ç®—å¯¹æ¯”ï¼ˆç¤ºä¾‹ï¼‰</h2>
    <div class="budget-table-note">
      ä»¥ä¸‹é¢„ç®—ä¸ºç¤ºä¾‹æ•°æ®ï¼Œå¯æ ¹æ®å®é™…å…¬å¸å¹´åº¦é¢„ç®—é…ç½®åœ¨å‰ç«¯æˆ–åç«¯ã€‚
    </div>
    <table id="budget-table">
      <thead>
        <tr>
          <th>éƒ¨é—¨</th>
          <th>é¢„ç®—ï¼ˆå…ƒ/æœˆï¼‰</th>
          <th>å®é™…ï¼ˆå…ƒï¼‰</th>
          <th>åå·®</th>
          <th>åå·®ç‡</th>
        </tr>
      </thead>
      <tbody id="budget-tbody">
        <tr><td colspan="5" class="loading">åŠ è½½ä¸­...</td></tr>
      </tbody>
    </table>

    <h2 class="section-title"><i class="ph ph-lightbulb-filament"></i> ğŸ’¡ è´¢åŠ¡æ´å¯Ÿ</h2>
    <div id="insight-box" class="insight-box">
      æ­£åœ¨åˆ†ææ•°æ®...
    </div>

    <h2 class="section-title"><i class="ph ph-cpu"></i> æŒ‰æä¾›å•†-æ¨¡å‹ç»Ÿè®¡</h2>
    <table id="provider-table">
      <thead>
        <tr>
          <th>æä¾›å•†</th>
          <th>æ¨¡å‹</th>
          <th>Prompt Tokens</th>
          <th>Completion Tokens</th>
          <th>Total Tokens</th>
          <th>é¢„è®¡è´¹ç”¨(å…ƒ)</th>
        </tr>
      </thead>
      <tbody id="provider-tbody">
        <tr><td colspan="6" class="loading">åŠ è½½ä¸­...</td></tr>
      </tbody>
    </table>

    <h2 class="section-title"><i class="ph ph-users-three"></i> æŒ‰æ¥æºç»Ÿè®¡ï¼ˆéƒ¨é—¨ / å‘˜å·¥ / é¡¹ç›® / åŠ©æ‰‹ï¼‰</h2>
    <table id="source-table">
      <thead>
        <tr>
          <th>æ¥æºç±»å‹</th>
          <th>æ¥æºåç§°</th>
          <th>Prompt Tokens</th>
          <th>Completion Tokens</th>
          <th>Total Tokens</th>
          <th>é¢„è®¡è´¹ç”¨(å…ƒ)</th>
        </tr>
      </thead>
      <tbody id="source-tbody">
        <tr><td colspan="6" class="loading">åŠ è½½ä¸­...</td></tr>
      </tbody>
    </table>

    <h2 class="section-title"><i class="ph ph-list-magnifying-glass"></i> è¯¦ç»†è°ƒç”¨è®°å½•</h2>
    <table id="detail-table">
      <thead>
        <tr>
          <th>æ—¶é—´</th>
          <th>æä¾›å•†</th>
          <th>æ¨¡å‹</th>
          <th>Prompt</th>
          <th>Completion</th>
          <th>Total</th>
          <th>æ¥æº</th>
        </tr>
      </thead>
      <tbody id="detail-tbody">
        <tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const API_BASE = 'http://localhost:8080';

    let allRecords = [];
    // ç¤ºä¾‹éƒ¨é—¨æœˆåº¦é¢„ç®—ï¼ˆå…ƒï¼‰ï¼Œå½“å‰å…¨éƒ¨è®¾ä¸º 0ï¼Œè¡¨ç¤ºå°šæœªå½•å…¥æ­£å¼é¢„ç®—
    const DEPT_BUDGET = {
      'ç¨‹åºéƒ¨': 0,
      'å®£ä¼ éƒ¨': 0,
      'é¡¹ç›®éƒ¨': 0,
      'è´¢åŠ¡éƒ¨': 0,
      'å¸‚åœºéƒ¨': 0,
      'äººäº‹éƒ¨': 0,
      'è¿è¥éƒ¨': 0
    };

    function inDateRange(time, days) {
      if (!days || days === 'all') return true;
      const t = new Date(time).getTime();
      if (Number.isNaN(t)) return false;
      const now = Date.now();
      const delta = days * 24 * 60 * 60 * 1000;
      return now - t <= delta;
    }

    function applyFilters() {
      const rangeVal = document.getElementById('date-range').value;
      const providerVal = document.getElementById('provider-filter').value;
      const sourceTypeVal = document.getElementById('source-type-filter').value;

      const days = rangeVal === 'all' ? null : parseInt(rangeVal, 10);

      return allRecords.filter(rec => {
        if (days && !inDateRange(rec.time, days)) return false;
        if (providerVal && rec.provider !== providerVal) return false;
        const srcType = rec.source?.type || 'unknown';
        if (sourceTypeVal && srcType !== sourceTypeVal) return false;
        return true;
      });
    }

    function rebuildProviderFilterOptions(records) {
      const select = document.getElementById('provider-filter');
      const old = select.value;
      const set = new Set(records.map(r => r.provider).filter(Boolean));
      select.innerHTML = '<option value="">å…¨éƒ¨</option>';
      Array.from(set).sort().forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        select.appendChild(opt);
      });
      if (old && set.has(old)) {
        select.value = old;
      }
    }

    function renderTrendChart(dateAggCost) {
      const container = document.getElementById('trend-chart');
      if (!container) return;
      const entries = Object.entries(dateAggCost).sort((a, b) => a[0].localeCompare(b[0]));
      if (!entries.length) {
        container.innerHTML = '<div class="empty">æš‚æ— è¶‹åŠ¿æ•°æ®</div>';
        return;
      }
      const max = Math.max(...entries.map(([, v]) => v)) || 1;
      const bars = entries.map(([day, cost]) => {
        const h = Math.max(8, (cost / max) * 100);
        const label = day.slice(5); // MM-DD
        return `
          <div class="trend-bar" title="${day}ï¼šçº¦ ${cost.toFixed(2)} å…ƒ">
            <div class="trend-bar-inner" style="height: ${h}%"></div>
            <span class="trend-bar-label">${label}</span>
          </div>
        `;
      });
      container.innerHTML = bars.join('');
    }

    function renderTopN(providerAgg, sourceAgg) {
      const modelList = document.getElementById('topn-models');
      const sourceList = document.getElementById('topn-sources');
      if (!modelList || !sourceList) return;

      const modelArr = [];
      Object.entries(providerAgg).forEach(([prov, models]) => {
        Object.entries(models).forEach(([model, stat]) => {
          modelArr.push({
            label: `${prov} / ${model}`,
            cost: stat.total_cost || 0
          });
        });
      });
      modelArr.sort((a, b) => b.cost - a.cost);
      const topModels = modelArr.slice(0, 5);
      if (!topModels.length) {
        modelList.innerHTML = '<li class="empty">æš‚æ— æ•°æ®</li>';
      } else {
        modelList.innerHTML = topModels.map(item => `
          <li class="topn-item">
            <span class="topn-item-label">${item.label}</span>
            <span class="topn-item-value">${item.cost.toFixed(2)} å…ƒ</span>
          </li>
        `).join('');
      }

      const sourceArr = [];
      Object.values(sourceAgg).forEach(stat => {
        sourceArr.push({
          type: stat.type,
          label: stat.label,
          cost: stat.total_cost || 0
        });
      });
      sourceArr.sort((a, b) => b.cost - a.cost);
      const topSources = sourceArr.slice(0, 5);
      if (!topSources.length) {
        sourceList.innerHTML = '<li class="empty">æš‚æ— æ•°æ®</li>';
      } else {
        sourceList.innerHTML = topSources.map(item => `
          <li class="topn-item">
            <span class="topn-item-label">${item.label} (${item.type})</span>
            <span class="topn-item-value">${item.cost.toFixed(2)} å…ƒ</span>
          </li>
        `).join('');
      }
    }

    function renderBudgetTable(sourceAgg) {
      const tbody = document.getElementById('budget-tbody');
      if (!tbody) return;
      const rows = [];
      Object.entries(DEPT_BUDGET).forEach(([dept, budget]) => {
        const key = Object.keys(sourceAgg).find(k => k.startsWith('department:') && k.includes(dept));
        const stat = key ? sourceAgg[key] : null;
        const actual = stat ? (stat.total_cost || 0) : 0;
        const diff = actual - budget;
        const rate = budget ? diff / budget : 0;
        let cls = '';
        if (diff > 0 && rate > 0.1) cls = 'budget-over';
        else if (diff < 0 && Math.abs(rate) > 0.1) cls = 'budget-under';
        else if (Math.abs(rate) >= 0.05) cls = 'budget-near';
        rows.push(`
          <tr>
            <td>${dept}</td>
            <td>${budget.toFixed(2)}</td>
            <td>${actual.toFixed(2)}</td>
            <td class="${cls}">${diff >= 0 ? '+' : ''}${diff.toFixed(2)}</td>
            <td class="${cls}">${(rate * 100).toFixed(1)}%</td>
          </tr>
        `);
      });
      tbody.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="5" class="empty">æš‚æ— é¢„ç®—é…ç½®</td></tr>';
    }

    function renderInsights(totalCost, providerAgg, sourceAgg, dateAggCost) {
      const box = document.getElementById('insight-box');
      if (!box) return;
      if (!totalCost) {
        box.textContent = 'å½“å‰æ•°æ®é‡è¾ƒå°‘ï¼Œæš‚æœªå‘ç°æ˜æ˜¾çš„æˆæœ¬ç‰¹å¾ã€‚';
        return;
      }
      const insights = [];

      // 1. æˆæœ¬é›†ä¸­åœ¨å“ªäº›æ¨¡å‹ / å‚å•†
      let maxModelLabel = '';
      let maxModelCost = 0;
      Object.entries(providerAgg).forEach(([prov, models]) => {
        Object.entries(models).forEach(([model, stat]) => {
          const cost = stat.total_cost || 0;
          if (cost > maxModelCost) {
            maxModelCost = cost;
            maxModelLabel = `${prov} / ${model}`;
          }
        });
      });
      if (maxModelCost > 0) {
        const share = (maxModelCost / totalCost) * 100;
        insights.push(`å½“å‰ AI æˆæœ¬ä¸»è¦é›†ä¸­åœ¨ã€Œ${maxModelLabel}ã€ï¼Œçº¦å æ€»æˆæœ¬çš„ ${share.toFixed(1)}%ã€‚`);
      }

      // 2. æ˜¯å¦æœ‰éƒ¨é—¨æ˜æ˜¾è¶…å‡ºé¢„ç®—
      let worstDept = null;
      let worstRate = 0;
      Object.entries(DEPT_BUDGET).forEach(([dept, budget]) => {
        const key = Object.keys(sourceAgg).find(k => k.startsWith('department:') && k.includes(dept));
        const stat = key ? sourceAgg[key] : null;
        const actual = stat ? (stat.total_cost || 0) : 0;
        if (!budget) return;
        const rate = budget ? (actual - budget) / budget : 0;
        if (rate > worstRate && rate > 0.1) {
          worstRate = rate;
          worstDept = { dept, budget, actual, rate };
        }
      });
      if (worstDept) {
        insights.push(`ã€Œ${worstDept.dept}ã€AI æˆæœ¬è¶…å‡ºæœ¬æœˆé¢„ç®—çº¦ ${(worstDept.rate * 100).toFixed(1)}%ï¼Œå»ºè®®å¤æŸ¥è°ƒç”¨ç­–ç•¥æˆ–é¢„ç®—è®¾ç½®ã€‚`);
      }

      // 3. è¶‹åŠ¿æ˜¯å¦æœ‰æ˜æ˜¾æŠ¬å‡
      const days = Object.entries(dateAggCost).sort((a, b) => a[0].localeCompare(b[0]));
      if (days.length >= 5) {
        const last = days[days.length - 1][1];
        const prevAvg = days.slice(0, -1).reduce((sum, [, v]) => sum + v, 0) / (days.length - 1);
        if (last > prevAvg * 1.4 && last > 50) {
          insights.push(`æœ€è¿‘ä¸€å¤©çš„ AI æˆæœ¬ï¼ˆçº¦ ${last.toFixed(2)} å…ƒï¼‰æ˜æ˜¾é«˜äºå‰æœŸå¹³å‡æ°´å¹³ï¼Œå»ºè®®æ’æŸ¥æ˜¯å¦æœ‰é›†ä¸­å¤§æ‰¹é‡è°ƒç”¨ã€‚`);
        }
      }

      if (!insights.length) {
        box.textContent = 'å½“å‰å„é¡¹æˆæœ¬å‡åœ¨åˆç†èŒƒå›´å†…ï¼Œæœªå‘ç°æ˜æ˜¾å¼‚å¸¸ã€‚';
        return;
      }
      box.innerHTML = `<ul>${insights.map(t => `<li>${t}</li>`).join('')}</ul>`;
    }

    async function loadData() {
      try {
        document.getElementById('provider-tbody').innerHTML = '<tr><td colspan="6" class="loading">åŠ è½½ä¸­...</td></tr>';
        document.getElementById('source-tbody').innerHTML = '<tr><td colspan="6" class="loading">åŠ è½½ä¸­...</td></tr>';
        document.getElementById('detail-tbody').innerHTML = '<tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>';

        // å…ˆæ‹‰å–åŸå§‹è°ƒç”¨è®°å½•
        const rawResp = await fetch(`${API_BASE}/api/usage-records`);
        if (!rawResp.ok) throw new Error(`åŠ è½½å¤±è´¥ï¼ˆ${rawResp.status}ï¼‰`);
        allRecords = await rawResp.json();

        // åˆå§‹åŒ–æä¾›å•†ç­›é€‰é€‰é¡¹
        rebuildProviderFilterOptions(allRecords);

        // æŒ‰å½“å‰ç­›é€‰æ¡ä»¶é‡æ–°ç»Ÿè®¡
        const records = applyFilters();

        let totalTokens = 0;
        let totalCost = 0;
        let totalCalls = records.length;

        const providerAgg = {};
        const sourceAgg = {};
        const dateAggTokens = {};

        records.forEach(rec => {
          const prov = rec.provider || 'unknown';
          const model = rec.model || 'unknown';
          const u = rec.usage || {};
          const prompt = u.prompt_tokens || 0;
          const completion = u.completion_tokens || 0;
          const total = u.total_tokens || (prompt + completion);

          totalTokens += total;

          if (!providerAgg[prov]) providerAgg[prov] = {};
          if (!providerAgg[prov][model]) {
            providerAgg[prov][model] = {
              prompt_tokens: 0,
              completion_tokens: 0,
              total_tokens: 0,
              total_cost: 0
            };
          }
          providerAgg[prov][model].prompt_tokens += prompt;
          providerAgg[prov][model].completion_tokens += completion;
          providerAgg[prov][model].total_tokens += total;

          const src = rec.source || {};
          const srcType = src.type || 'unknown';
          const srcLabel =
            srcType === 'employee'
              ? (src.employeeName || `å‘˜å·¥#${src.employeeId || '-'}`)
              : srcType === 'department'
                ? (src.deptName || 'æŸéƒ¨é—¨')
                : srcType === 'project'
                  ? (src.projectName || 'æŸé¡¹ç›®')
                  : srcType === 'assistant'
                    ? 'å°ç¢ŸåŠ©æ‰‹'
                    : srcType === 'global-assistant'
                      ? 'é¡¶éƒ¨ AI åŠ©æ‰‹'
                      : 'æœªæ ‡æ³¨æ¥æº';
          const key = `${srcType}:${srcLabel}`;
          if (!sourceAgg[key]) {
            sourceAgg[key] = {
              type: srcType,
              label: srcLabel,
              prompt_tokens: 0,
              completion_tokens: 0,
              total_tokens: 0,
              total_cost: 0
            };
          }
          sourceAgg[key].prompt_tokens += prompt;
          sourceAgg[key].completion_tokens += completion;
          sourceAgg[key].total_tokens += total;

          if (rec.time) {
            const dayKey = new Date(rec.time).toISOString().slice(0, 10);
            if (!dateAggTokens[dayKey]) dateAggTokens[dayKey] = 0;
            dateAggTokens[dayKey] += total;
          }
        });

        // ç®€å•æŒ‰ç»Ÿä¸€å•ä»·ä¼°ç®—è´¹ç”¨ï¼ˆè¯¦ç»†å•ä»·å·²åœ¨æœåŠ¡å™¨ Word æŠ¥è¡¨ä¸­å¤„ç†ï¼‰
        const pricePerK = 0.02;
        Object.values(providerAgg).forEach(models => {
          Object.values(models).forEach(stat => {
            stat.total_cost = +(stat.total_tokens / 1000 * pricePerK).toFixed(4);
            totalCost += stat.total_cost;
          });
        });
        Object.values(sourceAgg).forEach(stat => {
          stat.total_cost = +(stat.total_tokens / 1000 * pricePerK).toFixed(4);
        });

        const dateAggCost = {};
        Object.entries(dateAggTokens).forEach(([day, tokens]) => {
          dateAggCost[day] = +(tokens / 1000 * pricePerK).toFixed(2);
        });

        const providerRows = [];
        Object.entries(providerAgg).forEach(([prov, models]) => {
          Object.entries(models).forEach(([model, stat]) => {
            providerRows.push(`
              <tr>
                <td>${prov}</td>
                <td>${model}</td>
                <td>${stat.prompt_tokens || 0}</td>
                <td>${stat.completion_tokens || 0}</td>
                <td>${stat.total_tokens || 0}</td>
                <td>${(stat.total_cost || 0).toFixed(4)}</td>
              </tr>
            `);
          });
        });

        const sourceRows = [];
        Object.values(sourceAgg).forEach(stat => {
          sourceRows.push(`
            <tr>
              <td>${stat.type}</td>
              <td>${stat.label}</td>
              <td>${stat.prompt_tokens || 0}</td>
              <td>${stat.completion_tokens || 0}</td>
              <td>${stat.total_tokens || 0}</td>
              <td>${(stat.total_cost || 0).toFixed(4)}</td>
            </tr>
          `);
        });

        document.getElementById('total-calls').textContent = totalCalls;
        document.getElementById('total-tokens').textContent = totalTokens.toLocaleString();
        document.getElementById('total-cost').textContent = totalCost.toFixed(4);

        document.getElementById('provider-tbody').innerHTML = providerRows.length ? providerRows.join('') : '<tr><td colspan="6" class="empty">æš‚æ— æ•°æ®</td></tr>';
        document.getElementById('source-tbody').innerHTML = sourceRows.length ? sourceRows.join('') : '<tr><td colspan="6" class="empty">æš‚æ— æ•°æ®</td></tr>';

        // æ˜ç»†è¡¨
        const detailRows = records.map(rec => {
          const srcType = rec.source?.type || 'unknown';
          const srcLabel = srcType === 'employee' ? rec.source?.employeeName :
                         srcType === 'department' ? rec.source?.deptName :
                         srcType === 'project' ? rec.source?.projectName :
                         srcType === 'assistant' ? 'å°ç¢ŸåŠ©æ‰‹' :
                         srcType === 'global-assistant' ? 'é¡¶éƒ¨ AI åŠ©æ‰‹' : 'æœªçŸ¥';
          return `
            <tr>
              <td>${rec.time ? new Date(rec.time).toLocaleString('zh-CN') : '-'}</td>
              <td>${rec.provider}</td>
              <td>${rec.model}</td>
              <td>${rec.usage?.prompt_tokens || 0}</td>
              <td>${rec.usage?.completion_tokens || 0}</td>
              <td>${rec.usage?.total_tokens || 0}</td>
              <td>${srcLabel}</td>
            </tr>
          `;
        });
        document.getElementById('detail-tbody').innerHTML = detailRows.length ? detailRows.join('') : '<tr><td colspan="7" class="empty">æš‚æ— æ•°æ®</td></tr>';

        // è¶‹åŠ¿å›¾ / TopN / é¢„ç®—å¯¹æ¯” / æ´å¯Ÿ
        renderTrendChart(dateAggCost);
        renderTopN(providerAgg, sourceAgg);
        renderBudgetTable(sourceAgg);
        renderInsights(totalCost, providerAgg, sourceAgg, dateAggCost);

      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        document.getElementById('provider-tbody').innerHTML = `<tr><td colspan="6" class="empty">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
        document.getElementById('source-tbody').innerHTML = `<tr><td colspan="6" class="empty">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
        document.getElementById('detail-tbody').innerHTML = `<tr><td colspan="7" class="empty">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
      }
    }

    function exportDoc() {
      // å¤ç”¨åç«¯å·²æœ‰çš„ Word/RTF æŠ¥è¡¨å¯¼å‡ºæ¥å£
      window.open(`${API_BASE}/api/usage-report-doc`, '_blank');
    }

    document.getElementById('date-range').addEventListener('change', loadData);
    document.getElementById('provider-filter').addEventListener('change', loadData);
    document.getElementById('source-type-filter').addEventListener('change', loadData);

    loadData();
  </script>
</body>
</html>
